<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sprite! ‚Äî Game Asset Generator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');

:root {
  --bg:      #080810;
  --bg2:     #0e0e1a;
  --bg3:     #161625;
  --bg4:     #1e1e30;
  --border:  #2a2a42;
  --border2: #3a3a55;
  --accent:  #ff5f1f;
  --accent2: #a855f7;
  --accent3: #22d3ee;
  --accent4: #22c55e;
  --text:    #e2e2f0;
  --muted:   #6868a0;
  --muted2:  #4a4a70;
  --glow:    rgba(255,95,31,0.15);
  --glow2:   rgba(168,85,247,0.12);
}

* { margin:0; padding:0; box-sizing:border-box; }

::selection { background: var(--accent); color:#000; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Space Mono', monospace;
  min-height: 100vh;
  overflow: hidden;
/* ‚ïê‚ïê‚ïê LIGHT THEME ‚ïê‚ïê‚ïê */
[data-theme="light"] {
  --bg:      #f0f0f8;
  --bg2:     #e4e4f0;
  --bg3:     #d8d8ea;
  --bg4:     #ccccde;
  --border:  #b0b0cc;
  --border2: #9090b8;
  --accent:  #d94a00;
  --accent2: #8b35d6;
  --accent3: #0891b2;
  --accent4: #15803d;
  --text:    #1a1a2e;
  --muted:   #5a5a80;
  --muted2:  #7878a0;
  --glow:    rgba(217,74,0,0.12);
  --glow2:   rgba(139,53,214,0.10);
}

[data-theme="light"] body::before {
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.015) 2px, rgba(0,0,0,0.015) 4px);
}

[data-theme="light"] .asset-img-wrap,
[data-theme="light"] .pack-cell-img {
  background: repeating-conic-gradient(#d8d8ea 0% 25%, #ccccde 0% 50%) 0 0/20px 20px;
}

[data-theme="light"] textarea#prompt,
[data-theme="light"] select,
[data-theme="light"] .addon-btn,
[data-theme="light"] .btn-sm,
[data-theme="light"] .type-tab,
[data-theme="light"] .eng-btn,
[data-theme="light"] .sug-btn,
[data-theme="light"] .hist-item,
[data-theme="light"] .batch-item,
[data-theme="light"] .pack-cell,
[data-theme="light"] .view-cell,
[data-theme="light"] .anim-strip,
[data-theme="light"] .tilemap-wrap,
[data-theme="light"] #peCanvasWrap {
  background: var(--bg3);
}

[data-theme="light"] #peCanvasWrap {
  background: repeating-conic-gradient(#c8c8da 0% 25%, #d8d8ea 0% 50%) 0 0/16px 16px;
}

[data-theme="light"] code,
[data-theme="light"] .pe-tool,
[data-theme="light"] .pe-bs {
  background: var(--bg4);
}

/* Theme toggle button */
.theme-toggle {
  width: 52px; height: 27px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 14px;
  cursor: pointer;
  position: relative;
  transition: background .25s;
  flex-shrink: 0;
}
.theme-toggle::before {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 19px; height: 19px;
  border-radius: 50%;
  background: var(--accent);
  transition: transform .25s, background .25s;
  display: flex; align-items: center; justify-content: center;
}
[data-theme="light"] .theme-toggle::before {
  transform: translateX(25px);
  background: var(--accent);
}
.theme-toggle-wrap {
  display: flex; align-items: center; gap: 7px; font-size: 0.6rem; color: var(--muted);
}
.theme-toggle-icon { font-size: 0.85rem; line-height: 1; user-select: none; }

}

/* SCANLINE BG */
body::before {
  content:'';
  position:fixed; inset:0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.01) 2px, rgba(255,255,255,0.01) 4px);
  pointer-events:none; z-index:0;
}

/* SCROLLBAR */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--bg2); }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
header {
  position:fixed; top:0; left:0; right:0; height:54px;
  background: rgba(8,8,16,0.95);
  border-bottom: 1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
  padding: 0 20px;
  z-index:200;
  backdrop-filter: blur(12px);
}

.logo {
  font-family:'Syne',sans-serif;
  font-weight:800;
  font-size:1.5rem;
  color:var(--accent);
  letter-spacing:-1px;
  display:flex; align-items:center; gap:10px;
}
.logo-dot { color:var(--accent2); }
.logo-sub {
  font-family:'Space Mono'; font-size:0.55rem; color:var(--muted);
  letter-spacing:2px; text-transform:uppercase; margin-top:2px;
}
.header-center { display:flex; gap:6px; }
.hbadge {
  font-size:0.6rem; padding:3px 10px; border-radius:20px;
  border:1px solid var(--border2); color:var(--muted); letter-spacing:1px;
}
.hbadge.active { border-color:var(--accent); color:var(--accent); }
.header-right { display:flex; align-items:center; gap:12px; }
.version { font-size:0.6rem; color:var(--muted2); }

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.app {
  display:grid;
  grid-template-columns: 280px 1fr 290px;
  height: calc(100vh - 54px);
  margin-top:54px;
  position:relative; z-index:1;
}

/* ‚ïê‚ïê‚ïê SIDEBAR LEFT ‚ïê‚ïê‚ïê */
.sidebar-left {
  border-right:1px solid var(--border);
  background:var(--bg2);
  overflow-y:auto;
  display:flex; flex-direction:column;
}

.sb-section { padding:16px; border-bottom:1px solid var(--border); }
.sb-title {
  font-size:0.6rem; color:var(--accent); letter-spacing:3px;
  text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; gap:6px;
}
.sb-title::after { content:''; flex:1; height:1px; background:var(--border); }

/* Prompt box */
.prompt-wrap { position:relative; }
textarea#prompt {
  width:100%; height:90px;
  background:var(--bg3); border:1px solid var(--border);
  color:var(--text); font-family:'Space Mono'; font-size:0.72rem;
  padding:10px; border-radius:6px; resize:vertical;
  line-height:1.5; outline:none;
  transition:border-color .2s;
}
textarea#prompt:focus { border-color:var(--accent); box-shadow:0 0 0 2px var(--glow); }
textarea#prompt::placeholder { color:var(--muted2); }

/* Generate button */
.btn-gen {
  width:100%; padding:11px;
  background: linear-gradient(135deg, var(--accent), #ff8c00);
  border:none; color:#000; font-family:'Space Mono'; font-weight:700;
  font-size:0.75rem; letter-spacing:2px; border-radius:6px; cursor:pointer;
  margin-top:8px; text-transform:uppercase;
  transition:transform .1s, box-shadow .2s;
  position:relative; overflow:hidden;
}
.btn-gen::before {
  content:''; position:absolute; inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,0.2),transparent);
  opacity:0; transition:opacity .2s;
}
.btn-gen:hover::before { opacity:1; }
.btn-gen:hover { box-shadow:0 0 20px rgba(255,95,31,0.4); }
.btn-gen:active { transform:scale(0.98); }
.btn-gen.loading { opacity:0.7; cursor:wait; }

/* Select controls */
select, .select-like {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  color:var(--text); font-family:'Space Mono'; font-size:0.7rem;
  padding:7px 10px; border-radius:5px; outline:none; cursor:pointer;
  appearance:none; margin-bottom:8px;
}
select:focus { border-color:var(--accent2); }

.ctrl-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.ctrl-row label { font-size:0.62rem; color:var(--muted); white-space:nowrap; min-width:60px; }
.ctrl-row input[type=range] {
  flex:1; accent-color:var(--accent2); cursor:pointer;
}
.ctrl-row .val { font-size:0.62rem; color:var(--accent2); min-width:30px; text-align:right; }

/* Type tabs */
.type-tabs { display:flex; flex-wrap:wrap; gap:4px; }
.type-tab {
  font-family:'Space Mono'; font-size:0.62rem; padding:4px 8px;
  border:1px solid var(--border); border-radius:4px; cursor:pointer;
  color:var(--muted); background:transparent; transition:all .15s;
}
.type-tab:hover { border-color:var(--border2); color:var(--text); }
.type-tab.active { border-color:var(--accent2); color:var(--accent2); background:rgba(168,85,247,0.1); }

/* Palette swatches */
.palette-grid { display:flex; flex-wrap:wrap; gap:4px; }
.pal-swatch {
  width:28px; height:28px; border-radius:4px; cursor:pointer;
  border:2px solid transparent; transition:all .15s;
  position:relative;
}
.pal-swatch:hover { transform:scale(1.1); }
.pal-swatch.active { border-color:#fff; }
.pal-swatch[title]::after {
  content:attr(title); position:absolute; bottom:calc(100%+4px);
  left:50%; transform:translateX(-50%);
  font-size:0.55rem; white-space:nowrap; background:var(--bg3);
  padding:2px 6px; border-radius:3px; color:var(--text);
  opacity:0; pointer-events:none; transition:opacity .15s;
}
.pal-swatch:hover::after { opacity:1; }

/* Addon list */
.addon-list { display:flex; flex-direction:column; gap:3px; }
.addon-btn {
  background:var(--bg3); border:1px solid var(--border);
  color:var(--muted); font-family:'Space Mono'; font-size:0.65rem;
  padding:7px 10px; border-radius:5px; cursor:pointer; text-align:left;
  display:flex; align-items:center; gap:8px;
  transition:all .15s;
}
.addon-btn:hover { border-color:var(--accent3); color:var(--accent3); background:rgba(34,211,238,0.05); }
.addon-btn .addon-icon { font-size:0.9rem; }
.addon-btn .addon-label { flex:1; }
.addon-btn .addon-badge {
  font-size:0.5rem; padding:1px 5px; border-radius:10px;
  background:rgba(34,211,238,0.15); color:var(--accent3); border:1px solid rgba(34,211,238,0.2);
}

/* Engine exports */
.engine-grid { display:flex; flex-wrap:wrap; gap:4px; }
.eng-btn {
  flex:1; min-width:calc(50% - 2px);
  font-family:'Space Mono'; font-size:0.6rem; padding:6px 4px;
  background:var(--bg3); border:1px solid var(--border);
  color:var(--muted); cursor:pointer; border-radius:4px; text-align:center;
  transition:all .15s;
}
.eng-btn:hover { background:var(--bg4); color:var(--text); border-color:var(--border2); }
.eng-btn.unity:hover   { border-color:#3d8ff5; color:#3d8ff5; }
.eng-btn.unreal:hover  { border-color:#1bafd6; color:#1bafd6; }
.eng-btn.godot:hover   { border-color:#478ccb; color:#478ccb; }
.eng-btn.gmaker:hover  { border-color:#c4a30a; color:#c4a30a; }

/* ‚ïê‚ïê‚ïê MAIN CANVAS ‚ïê‚ïê‚ïê */
.main-canvas {
  background:var(--bg);
  display:flex; flex-direction:column;
  overflow:hidden;
}

/* Tab bar */
.tab-bar {
  display:flex; border-bottom:1px solid var(--border);
  background:var(--bg2); padding: 0 16px; gap:2px;
}
.tab {
  font-size:0.65rem; letter-spacing:1px; text-transform:uppercase;
  padding:12px 14px; color:var(--muted); cursor:pointer; border:none;
  background:transparent; border-bottom:2px solid transparent; margin-bottom:-1px;
  transition:color .15s; font-family:'Space Mono';
  white-space:nowrap;
}
.tab:hover { color:var(--text); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }

/* Canvas area */
.canvas-area {
  flex:1; overflow:auto;
  display:flex; flex-direction:column; align-items:center;
  padding:20px; gap:16px;
}

/* Asset display */
.asset-display {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:10px; overflow:hidden;
  max-width:600px; width:100%;
}
.asset-header {
  padding:12px 16px; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
}
.asset-title { font-size:0.7rem; color:var(--text); }
.asset-meta { font-size:0.6rem; color:var(--muted); }

.asset-img-wrap {
  display:flex; align-items:center; justify-content:center;
  padding:24px; min-height:280px;
  background: repeating-conic-gradient(var(--bg3) 0% 25%, var(--bg4) 0% 50%) 0 0/20px 20px;
  position:relative;
}
.asset-img-wrap img {
  image-rendering:pixelated; max-width:100%; max-height:300px;
  border-radius:4px;
}
.asset-placeholder {
  display:flex; flex-direction:column; align-items:center; gap:12px; color:var(--muted);
  font-size:0.7rem;
}
.asset-placeholder .big-icon { font-size:3rem; opacity:0.3; }

.asset-footer {
  padding:10px 16px; display:flex; gap:8px; border-top:1px solid var(--border);
  flex-wrap:wrap;
}
.btn-sm {
  font-family:'Space Mono'; font-size:0.62rem; padding:5px 12px;
  background:var(--bg3); border:1px solid var(--border);
  color:var(--muted); border-radius:4px; cursor:pointer; transition:all .15s;
}
.btn-sm:hover { color:var(--text); border-color:var(--border2); }
.btn-sm.primary { border-color:var(--accent); color:var(--accent); }
.btn-sm.primary:hover { background:rgba(255,95,31,0.1); }
.btn-sm.purple { border-color:var(--accent2); color:var(--accent2); }
.btn-sm.purple:hover { background:rgba(168,85,247,0.1); }

/* 3D Multi-view grid */
.view-panel {
  display:grid; grid-template-columns:1fr 1fr;
  gap:8px; padding:16px; background:var(--bg2);
  border:1px solid var(--border); border-radius:10px; max-width:600px; width:100%;
}
.view-cell {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:6px; overflow:hidden; position:relative;
}
.view-label {
  position:absolute; top:6px; left:8px;
  font-size:0.55rem; color:var(--accent3); letter-spacing:2px;
  text-transform:uppercase; background:rgba(0,0,0,0.5);
  padding:2px 6px; border-radius:10px;
}
.view-cell img { width:100%; display:block; }
.view-loading {
  display:flex; align-items:center; justify-content:center;
  height:140px; color:var(--muted); font-size:0.65rem;
}

/* Pack display */
.pack-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
  max-width:600px; width:100%;
}
.pack-cell {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:8px; overflow:hidden; text-align:center;
}
.pack-cell-label {
  font-size:0.55rem; color:var(--muted); letter-spacing:1px; padding:6px 0;
  border-bottom:1px solid var(--border); text-transform:uppercase;
}
.pack-cell-img {
  display:flex; align-items:center; justify-content:center;
  padding:10px; min-height:80px;
  background: repeating-conic-gradient(var(--bg3) 0% 25%, var(--bg4) 0% 50%) 0 0/12px 12px;
}
.pack-cell-img img { image-rendering:pixelated; max-height:80px; max-width:100%; }

/* Animation strip */
.anim-strip {
  max-width:600px; width:100%; overflow-x:auto;
  background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:12px;
}
.anim-strip img {
  image-rendering:pixelated; display:block;
  border:1px solid var(--border); border-radius:4px;
}

/* Tilemap display */
.tilemap-wrap {
  max-width:600px; width:100%;
  background:var(--bg2); border:1px solid var(--border); border-radius:8px;
  padding:12px; overflow:auto;
}
.tilemap-wrap img { image-rendering:pixelated; max-width:100%; }

/* Loading spinner */
.spinner {
  width:36px; height:36px; border:3px solid var(--border);
  border-top-color:var(--accent); border-radius:50%;
  animation:spin .7s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* Batch results */
.batch-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
  gap:8px; max-width:600px; width:100%;
}
.batch-item {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:6px; overflow:hidden; text-align:center;
}
.batch-item img { image-rendering:pixelated; width:100%; display:block; }
.batch-item-lbl { font-size:0.5rem; color:var(--muted); padding:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Info tags */
.info-tags { display:flex; flex-wrap:wrap; gap:5px; max-width:600px; width:100%; }
.itag {
  font-size:0.58rem; padding:3px 8px; border-radius:12px;
  border:1px solid var(--border2); color:var(--muted);
}
.itag span { color:var(--accent3); }

/* Toast */
.toast-container { position:fixed; bottom:20px; right:20px; z-index:999; display:flex; flex-direction:column; gap:6px; }
.toast {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--text); font-family:'Space Mono'; font-size:0.65rem;
  padding:10px 16px; border-radius:6px; animation:toast-in .2s ease;
  max-width:280px;
}
.toast.success { border-color:var(--accent4); color:var(--accent4); }
.toast.error { border-color:#f87171; color:#f87171; }
@keyframes toast-in { from { transform:translateX(20px); opacity:0; } to { transform:translateX(0); opacity:1; } }

/* ‚ïê‚ïê‚ïê SIDEBAR RIGHT ‚ïê‚ïê‚ïê */
.sidebar-right {
  border-left:1px solid var(--border);
  background:var(--bg2);
  overflow-y:auto;
}

/* History */
.history-list { display:flex; flex-direction:column; gap:6px; padding:12px; }
.hist-item {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:6px; overflow:hidden; cursor:pointer;
  transition:border-color .15s; display:flex; align-items:center; gap:8px; padding:6px;
}
.hist-item:hover { border-color:var(--border2); }
.hist-thumb { width:40px; height:40px; image-rendering:pixelated; border-radius:3px; flex-shrink:0; }
.hist-info { min-width:0; }
.hist-prompt { font-size:0.6rem; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.hist-meta { font-size:0.55rem; color:var(--muted); }

/* Color palette info */
.pal-preview {
  display:flex; gap:3px; padding:10px 12px; flex-wrap:wrap;
}
.pal-dot { width:20px; height:20px; border-radius:3px; }

/* Shortcut guide */
.shortcut-table { padding:10px 12px; }
.sc-row { display:flex; justify-content:space-between; font-size:0.6rem; color:var(--muted); padding:4px 0; border-bottom:1px solid var(--border); }
.sc-key { color:var(--accent3); font-family:'JetBrains Mono'; background:var(--bg3); padding:1px 5px; border-radius:3px; font-size:0.58rem; }

/* Prompt suggestions */
.suggestions { display:flex; flex-wrap:wrap; gap:4px; padding:10px 12px; }
.sug-btn {
  font-family:'Space Mono'; font-size:0.58rem; padding:3px 8px;
  background:var(--bg3); border:1px solid var(--border);
  color:var(--muted); border-radius:12px; cursor:pointer; transition:all .15s;
}
.sug-btn:hover { color:var(--text); border-color:var(--border2); }

/* Empty state pulse */
@keyframes pulse { 0%,100%{opacity:.4} 50%{opacity:.8} }
.pulse { animation:pulse 2s infinite; }

/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.8);
  z-index:500; display:flex; align-items:center; justify-content:center;
  display:none;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--bg2); border:1px solid var(--border2);
  border-radius:12px; width:90%; max-width:480px; max-height:80vh;
  overflow:auto; padding:24px;
}
.modal h2 { font-family:'Syne',sans-serif; font-size:1.1rem; color:var(--accent); margin-bottom:16px; }
.modal p { font-size:0.7rem; color:var(--muted); line-height:1.7; margin-bottom:10px; }
.modal .close { float:right; background:none; border:1px solid var(--border); color:var(--muted); padding:4px 10px; border-radius:4px; cursor:pointer; font-family:'Space Mono'; font-size:0.65rem; }
.modal code { background:var(--bg3); padding:2px 6px; border-radius:3px; font-family:'JetBrains Mono'; font-size:0.65rem; color:var(--accent3); }
.modal pre { background:var(--bg3); border:1px solid var(--border); border-radius:6px; padding:12px; font-family:'JetBrains Mono'; font-size:0.65rem; line-height:1.6; color:var(--accent3); overflow:auto; margin:8px 0; white-space:pre-wrap; }

/* Batch prompts textarea */
#batchPrompts {
  width:100%; height:100px;
  background:var(--bg3); border:1px solid var(--border);
  color:var(--text); font-family:'Space Mono'; font-size:0.68rem;
  padding:10px; border-radius:6px; resize:vertical; outline:none;
}
#batchPrompts:focus { border-color:var(--accent); }

/* Responsive tweaks */
@media (max-width:1100px) {
  .app { grid-template-columns: 250px 1fr 0; }
  .sidebar-right { display:none; }
}
@media (max-width:800px) {
  .app { grid-template-columns: 0 1fr 0; }
  .sidebar-left { display:none; }
}

/* ‚ïê‚ïê‚ïê PIXEL EDITOR ‚ïê‚ïê‚ïê */
.pe-tool {
  width:36px; height:36px; border-radius:6px;
  background:var(--bg3); border:1px solid var(--border);
  color:var(--text); font-size:1rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all .12s; padding:0;
}
.pe-tool:hover { background:var(--bg4); border-color:var(--border2); }
.pe-tool.active { background:rgba(255,95,31,0.15); border-color:var(--accent); color:var(--accent); }

.pe-bs {
  width:32px; height:32px; border-radius:5px;
  background:var(--bg3); border:1px solid var(--border);
  color:var(--muted); font-size:0.62rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-family:'Space Mono'; transition:all .12s;
}
.pe-bs:hover { border-color:var(--border2); color:var(--text); }
.pe-bs.active { border-color:var(--accent2); color:var(--accent2); background:rgba(168,85,247,0.12); }

#peCanvas { cursor:crosshair; }
#peCanvas.cursor-eraser { cursor: cell; }
#peCanvas.cursor-fill { cursor: copy; }
#peCanvas.cursor-eyedropper { cursor: crosshair; }

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div>
      <div>Sprite<span class="logo-dot">!</span></div>
      <div class="logo-sub">Game Asset Generator</div>
    </div>
  </div>
  <div class="header-center">
    <span class="hbadge active">2D</span>
    <span class="hbadge active">3D</span>
    <span class="hbadge active">Tilemap</span>
    <span class="hbadge active">Animation</span>
    <span class="hbadge active">Pack</span>
    <span class="hbadge">No API</span>
  </div>
  <div class="header-right">
    <div class="theme-toggle-wrap">
      <span class="theme-toggle-icon" id="themeIconDark">üåô</span>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark theme" aria-label="Toggle theme"></button>
      <span class="theme-toggle-icon" id="themeIconLight">‚òÄ</span>
    </div>
    <span class="version">v1.0 ¬∑ by Shivani ‚ú¶</span>
  </div>
</header>

<!-- MAIN APP -->
<div class="app">

  <!-- ‚ïê‚ïê‚ïê SIDEBAR LEFT ‚ïê‚ïê‚ïê -->
  <div class="sidebar-left">

    <!-- PROMPT -->
    <div class="sb-section">
      <div class="sb-title">Prompt</div>
      <div class="prompt-wrap">
        <textarea id="prompt" placeholder="e.g. pixel art warrior character fire palette 64px&#10;&#10;sci-fi spaceship neon blue&#10;&#10;dungeon stone floor tile"></textarea>
      </div>
      <button class="btn-gen" id="generateBtn" onclick="generate()">‚ö° GENERATE</button>
    </div>

    <!-- TYPE -->
    <div class="sb-section">
      <div class="sb-title">Asset Type</div>
      <div class="type-tabs">
        <button class="type-tab active" data-type="sprite" onclick="setType(this,'sprite')">Sprite</button>
        <button class="type-tab" data-type="3d" onclick="setType(this,'3d')">3D</button>
        <button class="type-tab" data-type="tilemap" onclick="setType(this,'tilemap')">Tilemap</button>
        <button class="type-tab" data-type="animation" onclick="setType(this,'animation')">Animation</button>
        <button class="type-tab" data-type="pack" onclick="setType(this,'pack')">Full Pack</button>
        <button class="type-tab" data-type="iconset" onclick="setType(this,'iconset')">Icon Set</button>
        <button class="type-tab" data-type="atlas" onclick="setType(this,'atlas')">Atlas</button>
      </div>
    </div>

    <!-- CATEGORY -->
    <div class="sb-section">
      <div class="sb-title">Category</div>
      <select id="categorySelect">
        <option value="">Auto-detect</option>
        <option value="character">Character / NPC</option>
        <option value="tile">Tile / Floor</option>
        <option value="item">Item / Weapon</option>
        <option value="ui">UI Element</option>
        <option value="environment">Environment</option>
        <option value="vehicle">Vehicle</option>
        <option value="prop">Prop / Decor</option>
        <option value="particle">Particle / FX</option>
        <option value="icon">Icon / Badge</option>
      </select>

      <div class="sb-title" style="margin-top:8px">Style</div>
      <select id="styleSelect">
        <option value="">Auto-detect</option>
        <option value="pixel">Pixel Art</option>
        <option value="cartoon">Cartoon</option>
        <option value="neon">Neon / Glow</option>
        <option value="minimalist">Minimalist</option>
        <option value="fantasy">Fantasy</option>
        <option value="sci-fi">Sci-Fi</option>
      </select>
    </div>

    <!-- SIZE -->
    <div class="sb-section">
      <div class="sb-title">Size</div>
      <div class="ctrl-row">
        <label>Pixels</label>
        <input type="range" id="sizeRange" min="16" max="512" step="16" value="64" oninput="document.getElementById('sizeVal').textContent=this.value+'px'">
        <span class="val" id="sizeVal">64px</span>
      </div>
    </div>

    <!-- PALETTE -->
    <div class="sb-section">
      <div class="sb-title">Color Palette</div>
      <div class="palette-grid" id="paletteGrid"></div>
    </div>

    <!-- 15 ADDONS -->
    <div class="sb-section">
      <div class="sb-title">15 Addons</div>
      <div class="addon-list">
        <button class="addon-btn" onclick="addonNormalMap()">
          <span class="addon-icon">üó∫</span>
          <span class="addon-label">Normal Map</span>
          <span class="addon-badge">PBR</span>
        </button>
        <button class="addon-btn" onclick="addonEmissive()">
          <span class="addon-icon">‚ú®</span>
          <span class="addon-label">Emissive Map</span>
          <span class="addon-badge">Glow</span>
        </button>
        <button class="addon-btn" onclick="addonRoughness()">
          <span class="addon-icon">ü™®</span>
          <span class="addon-label">Roughness Map</span>
          <span class="addon-badge">PBR</span>
        </button>
        <button class="addon-btn" onclick="addonUpscale()">
          <span class="addon-icon">üîç</span>
          <span class="addon-label">4√ó Upscaler</span>
          <span class="addon-badge">HQ</span>
        </button>
        <button class="addon-btn" onclick="openPaletteSwap()">
          <span class="addon-icon">üé®</span>
          <span class="addon-label">Palette Swap</span>
          <span class="addon-badge">Recolor</span>
        </button>
        <button class="addon-btn" onclick="openBatch()">
          <span class="addon-icon">‚ö°</span>
          <span class="addon-label">Batch Generator</span>
          <span class="addon-badge">Bulk</span>
        </button>
        <button class="addon-btn" onclick="addonAtlas()">
          <span class="addon-icon">üì¶</span>
          <span class="addon-label">Texture Atlas</span>
          <span class="addon-badge">Pack</span>
        </button>
        <button class="addon-btn" onclick="addonIconSet()">
          <span class="addon-icon">üè∑</span>
          <span class="addon-label">Icon Set (4 sizes)</span>
          <span class="addon-badge">UI</span>
        </button>
        <button class="addon-btn" onclick="addonShadow()">
          <span class="addon-icon">üåë</span>
          <span class="addon-label">Drop Shadow</span>
          <span class="addon-badge">FX</span>
        </button>
        <button class="addon-btn" onclick="addonOutline()">
          <span class="addon-icon">üî≤</span>
          <span class="addon-label">Outline / Stroke</span>
          <span class="addon-badge">FX</span>
        </button>
        <button class="addon-btn" onclick="openAnimPreview()">
          <span class="addon-icon">‚ñ∂</span>
          <span class="addon-label">Animation Preview</span>
          <span class="addon-badge">Play</span>
        </button>
        <button class="addon-btn" onclick="openEngineExport('unity')">
          <span class="addon-icon">üéÆ</span>
          <span class="addon-label">Unity Export Script</span>
          <span class="addon-badge">C#</span>
        </button>
        <button class="addon-btn" onclick="openEngineExport('godot')">
          <span class="addon-icon">üïπ</span>
          <span class="addon-label">Godot Import Script</span>
          <span class="addon-badge">GDScript</span>
        </button>
        <button class="addon-btn" onclick="openEngineExport('unreal')">
          <span class="addon-icon">üéØ</span>
          <span class="addon-label">Unreal Import Script</span>
          <span class="addon-badge">Python</span>
        </button>
        <button class="addon-btn" onclick="openEngineExport('gamemaker')">
          <span class="addon-icon">üÉè</span>
          <span class="addon-label">GameMaker Script</span>
          <span class="addon-badge">GML</span>
        </button>
      </div>
    </div>

    <!-- ENGINE EXPORT -->
    <div class="sb-section">
      <div class="sb-title">Engine Integration</div>
      <div class="engine-grid">
        <button class="eng-btn unity" onclick="openEngineExport('unity')">‚¨° Unity</button>
        <button class="eng-btn unreal" onclick="openEngineExport('unreal')">‚óà Unreal</button>
        <button class="eng-btn godot" onclick="openEngineExport('godot')">‚óâ Godot</button>
        <button class="eng-btn gmaker" onclick="openEngineExport('gamemaker')">‚óÜ GameMaker</button>
      </div>
    </div>

  </div><!-- /sidebar-left -->


  <!-- ‚ïê‚ïê‚ïê MAIN CANVAS ‚ïê‚ïê‚ïê -->
  <div class="main-canvas">

    <div class="tab-bar">
      <button class="tab active" onclick="showTab('preview',this)">Preview</button>
      <button class="tab" onclick="showTab('3dviews',this)">3D Views</button>
      <button class="tab" onclick="showTab('pack',this)">Asset Pack</button>
      <button class="tab" onclick="showTab('animation',this)">Animation</button>
      <button class="tab" onclick="showTab('tilemap',this)">Tilemap</button>
      <button class="tab" onclick="showTab('batch',this)">Batch</button>
      <button class="tab" onclick="showTab('pixeleditor',this); initPixelEditor();">‚úè Pixel Editor</button>
    </div>

    <div class="canvas-area" id="canvasArea">

      <!-- Preview tab (default) -->
      <div id="tab-preview">
        <div class="asset-display" id="assetDisplay">
          <div class="asset-header">
            <span class="asset-title" id="assetTitle">Ready to generate</span>
            <span class="asset-meta" id="assetMeta">Enter a prompt ‚Üí</span>
          </div>
          <div class="asset-img-wrap" id="assetImgWrap">
            <div class="asset-placeholder pulse">
              <div class="big-icon">üéÆ</div>
              <div>Enter a prompt and click Generate</div>
              <div style="font-size:0.6rem;color:var(--muted2)">Supports: characters, tiles, items, environments, vehicles, props...</div>
            </div>
          </div>
          <div class="asset-footer" id="assetFooter" style="display:none">
            <button class="btn-sm primary" onclick="downloadCurrent()">‚Üì Download PNG</button>
            <button class="btn-sm purple" onclick="downloadZip()">‚Üì Full ZIP</button>
            <button class="btn-sm" onclick="copyToClipboard()">‚ßâ Copy</button>
            <button class="btn-sm" onclick="addVariant()">+ Variant</button>
          </div>
        </div>
        <div class="info-tags" id="infoTags" style="display:none"></div>
      </div>

      <!-- 3D Views tab -->
      <div id="tab-3dviews" style="display:none;width:100%;max-width:600px">
        <div class="view-panel" id="viewPanel">
          <div class="view-cell" id="view-front">
            <div class="view-label">FRONT</div>
            <div class="view-loading pulse">Generate a 3D asset first</div>
          </div>
          <div class="view-cell" id="view-rear">
            <div class="view-label">REAR</div>
            <div class="view-loading pulse">‚Äî</div>
          </div>
          <div class="view-cell" id="view-left">
            <div class="view-label">LEFT SIDE</div>
            <div class="view-loading pulse">‚Äî</div>
          </div>
          <div class="view-cell" id="view-top">
            <div class="view-label">TOP</div>
            <div class="view-loading pulse">‚Äî</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;max-width:600px;width:100%">
          <button class="btn-sm primary" onclick="download3dObj()">‚Üì Download .OBJ</button>
          <button class="btn-sm" onclick="download3dMtl()">‚Üì Download .MTL</button>
          <button class="btn-sm purple" onclick="downloadZip()">‚Üì Full ZIP</button>
        </div>
      </div>

      <!-- Pack tab -->
      <div id="tab-pack" style="display:none;width:100%;max-width:600px">
        <div class="pack-grid" id="packGrid">
          <div class="pack-cell"><div class="pack-cell-label">Base Sprite</div><div class="pack-cell-img pulse"><div class="big-icon" style="font-size:2rem;opacity:.2">üéÆ</div></div></div>
          <div class="pack-cell"><div class="pack-cell-label">Normal Map</div><div class="pack-cell-img pulse"><div class="big-icon" style="font-size:2rem;opacity:.2">üó∫</div></div></div>
          <div class="pack-cell"><div class="pack-cell-label">Emissive</div><div class="pack-cell-img pulse"><div class="big-icon" style="font-size:2rem;opacity:.2">‚ú®</div></div></div>
          <div class="pack-cell"><div class="pack-cell-label">Roughness</div><div class="pack-cell-img pulse"><div class="big-icon" style="font-size:2rem;opacity:.2">ü™®</div></div></div>
          <div class="pack-cell"><div class="pack-cell-label">4√ó Upscaled</div><div class="pack-cell-img pulse"><div class="big-icon" style="font-size:2rem;opacity:.2">üîç</div></div></div>
          <div class="pack-cell"><div class="pack-cell-label">Tilemap</div><div class="pack-cell-img pulse"><div class="big-icon" style="font-size:2rem;opacity:.2">üß©</div></div></div>
        </div>
        <div style="display:flex;gap:8px;max-width:600px;width:100%;margin-top:4px">
          <button class="btn-sm primary purple" onclick="downloadZip()">‚Üì Download Full Pack ZIP</button>
        </div>
      </div>

      <!-- Animation tab -->
      <div id="tab-animation" style="display:none;width:100%;max-width:600px">
        <div class="anim-strip" id="animStrip">
          <div style="color:var(--muted);font-size:0.7rem;padding:20px;text-align:center" class="pulse">Generate an animation to preview frames here</div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn-sm" id="animPlayBtn" onclick="playAnim()" style="display:none">‚ñ∂ Play</button>
          <button class="btn-sm primary" id="animDlBtn" onclick="downloadAnim()" style="display:none">‚Üì Download Sheet</button>
          <label style="font-size:0.62rem;color:var(--muted);display:flex;align-items:center;gap:6px">
            Frames: <input type="number" id="frameCount" value="8" min="2" max="24" style="width:50px;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:3px 6px;border-radius:3px;font-family:Space Mono">
          </label>
          <label style="font-size:0.62rem;color:var(--muted);display:flex;align-items:center;gap:6px">
            FPS: <input type="number" id="animFps" value="8" min="1" max="30" style="width:50px;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:3px 6px;border-radius:3px;font-family:Space Mono">
          </label>
        </div>
        <div id="animCanvas" style="margin-top:12px;display:none">
          <canvas id="animPreviewCanvas" width="64" height="64" style="image-rendering:pixelated;border:1px solid var(--border);border-radius:4px;"></canvas>
        </div>
      </div>

      <!-- Tilemap tab -->
      <div id="tab-tilemap" style="display:none;width:100%;max-width:600px">
        <div class="tilemap-wrap" id="tilemapWrap">
          <div style="color:var(--muted);font-size:0.7rem;padding:20px;text-align:center" class="pulse">Select "Tilemap" type and generate</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="font-size:0.62rem;color:var(--muted)">Cols: <input type="number" id="tilemapCols" value="4" min="1" max="8" style="width:45px;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:3px 6px;border-radius:3px;font-family:Space Mono"></label>
          <label style="font-size:0.62rem;color:var(--muted)">Rows: <input type="number" id="tilemapRows" value="4" min="1" max="8" style="width:45px;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:3px 6px;border-radius:3px;font-family:Space Mono"></label>
          <button class="btn-sm primary" id="tilemapDlBtn" onclick="downloadTilemap()" style="display:none">‚Üì Download Tilemap</button>
        </div>
      </div>

      <!-- Batch tab -->
      <div id="tab-batch" style="display:none;width:100%;max-width:600px">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px">
          <div class="sb-title">Batch Prompts (one per line)</div>
          <textarea id="batchPromptsMain" style="width:100%;height:90px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:Space Mono;font-size:0.68rem;padding:10px;border-radius:6px;resize:vertical;outline:none;" placeholder="warrior character fire&#10;wizard ice magic&#10;dungeon stone tile&#10;health potion red"></textarea>
          <button class="btn-gen" style="margin-top:8px" onclick="runBatch()">‚ö° BATCH GENERATE</button>
        </div>
        <div class="batch-grid" id="batchResultsMain"></div>
      </div>


      <!-- ‚ïê‚ïê PIXEL EDITOR TAB ‚ïê‚ïê -->
      <div id="tab-pixeleditor" style="display:none;width:100%;max-width:900px">
        <div id="pixelEditorRoot" style="display:flex;gap:12px;width:100%;flex-wrap:wrap">

          <!-- TOOLBAR LEFT -->
          <div id="peToolbar" style="display:flex;flex-direction:column;gap:6px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px;min-width:52px;align-items:center">

            <!-- Tools -->
            <div style="font-size:0.5rem;color:var(--muted);letter-spacing:2px;margin-bottom:2px">TOOLS</div>
            <button class="pe-tool active" id="tool-pencil" onclick="peTool('pencil',this)" title="Pencil (P)">‚úè</button>
            <button class="pe-tool" id="tool-brush" onclick="peTool('brush',this)" title="Brush (B)">üñå</button>
            <button class="pe-tool" id="tool-eraser" onclick="peTool('eraser',this)" title="Eraser (E)">‚óª</button>
            <button class="pe-tool" id="tool-fill" onclick="peTool('fill',this)" title="Fill / Bucket (F)">ü™£</button>
            <button class="pe-tool" id="tool-eyedropper" onclick="peTool('eyedropper',this)" title="Eyedropper (I)">üíß</button>
            <button class="pe-tool" id="tool-line" onclick="peTool('line',this)" title="Line (L)">‚ï±</button>
            <button class="pe-tool" id="tool-rect" onclick="peTool('rect',this)" title="Rectangle (R)">‚ñ≠</button>
            <button class="pe-tool" id="tool-circle" onclick="peTool('circle',this)" title="Circle (C)">‚óã</button>
            <button class="pe-tool" id="tool-select" onclick="peTool('select',this)" title="Select (S)">‚¨ö</button>

            <div style="width:36px;height:1px;background:var(--border);margin:4px 0"></div>

            <!-- Brush size -->
            <div style="font-size:0.5rem;color:var(--muted);letter-spacing:2px">SIZE</div>
            <div id="bsSwatch1" class="pe-bs active" onclick="peBrushSize(1,this)" title="1px">1</div>
            <div id="bsSwatch2" class="pe-bs" onclick="peBrushSize(2,this)" title="2px">2</div>
            <div id="bsSwatch4" class="pe-bs" onclick="peBrushSize(4,this)" title="4px">4</div>
            <div id="bsSwatch8" class="pe-bs" onclick="peBrushSize(8,this)" title="8px">8</div>

            <div style="width:36px;height:1px;background:var(--border);margin:4px 0"></div>

            <!-- Zoom -->
            <div style="font-size:0.5rem;color:var(--muted);letter-spacing:2px">ZOOM</div>
            <button class="pe-tool" onclick="peZoom(2)" title="Zoom In (+)">+</button>
            <button class="pe-tool" onclick="peZoom(-2)" title="Zoom Out (-)">‚àí</button>
            <div id="peZoomLabel" style="font-size:0.55rem;color:var(--accent3)">8√ó</div>
            <button class="pe-tool" onclick="peZoomFit()" title="Fit to view">‚ä°</button>

            <div style="width:36px;height:1px;background:var(--border);margin:4px 0"></div>

            <!-- Undo / Redo -->
            <button class="pe-tool" onclick="peUndo()" title="Undo (Ctrl+Z)">‚Ü©</button>
            <button class="pe-tool" onclick="peRedo()" title="Redo (Ctrl+Y)">‚Ü™</button>
          </div>

          <!-- CANVAS AREA -->
          <div style="flex:1;display:flex;flex-direction:column;gap:8px;min-width:300px">
            <!-- Canvas wrapper -->
            <div id="peCanvasWrap" style="background:repeating-conic-gradient(#1a1a28 0% 25%,#12121e 0% 50%) 0 0/16px 16px;border:1px solid var(--border);border-radius:8px;overflow:hidden;position:relative;cursor:crosshair;display:flex;align-items:flex-start;justify-content:flex-start;min-height:400px;max-height:520px;overflow:auto">
              <canvas id="peCanvas" style="image-rendering:pixelated;display:block;"></canvas>
              <!-- Selection overlay -->
              <div id="peSelectionBox" style="position:absolute;border:2px dashed var(--accent3);pointer-events:none;display:none"></div>
            </div>
            <!-- Status bar -->
            <div style="display:flex;gap:12px;font-size:0.58rem;color:var(--muted);align-items:center;flex-wrap:wrap">
              <span id="peCursorPos">x:‚Äî y:‚Äî</span>
              <span id="peCanvasSize">‚Äî</span>
              <span id="peCurrentTool" style="color:var(--accent3)">pencil</span>
              <span style="flex:1"></span>
              <button class="btn-sm" onclick="peClearCanvas()" style="font-size:0.58rem;padding:3px 8px">Clear</button>
              <button class="btn-sm" onclick="peLoadFromGenerated()" style="font-size:0.58rem;padding:3px 8px">‚Üê Load Generated</button>
              <button class="btn-sm primary" onclick="peExportPNG()" style="font-size:0.58rem;padding:3px 8px">‚Üì Export PNG</button>
            </div>
          </div>

          <!-- PALETTE + COLOR SIDEBAR -->
          <div style="display:flex;flex-direction:column;gap:8px;width:170px">

            <!-- Active colors -->
            <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px">
              <div style="font-size:0.55rem;color:var(--muted);letter-spacing:2px;margin-bottom:8px">COLORS</div>
              <!-- FG / BG swatches -->
              <div style="position:relative;width:64px;height:52px;margin:0 auto 10px">
                <!-- BG color -->
                <div id="peBgSwatch" onclick="peSwapColors()" style="position:absolute;bottom:0;right:0;width:36px;height:36px;border-radius:4px;border:2px solid var(--border2);cursor:pointer;background:#000000" title="Background color (right-click)"></div>
                <!-- FG color -->
                <div id="peFgSwatch" style="position:absolute;top:0;left:0;width:36px;height:36px;border-radius:4px;border:2px solid #fff;cursor:pointer;background:#ffffff" title="Foreground color" onclick="document.getElementById('peFgPicker').click()"></div>
                <!-- Swap icon -->
                <div onclick="peSwapColors()" style="position:absolute;top:0;right:0;font-size:0.65rem;color:var(--muted);cursor:pointer;background:var(--bg3);border-radius:3px;padding:1px 3px" title="Swap colors">‚áÑ</div>
              </div>

              <!-- Hidden color pickers -->
              <input type="color" id="peFgPicker" value="#ffffff" style="opacity:0;width:0;height:0;position:absolute" oninput="peSetFgColor(this.value)">
              <input type="color" id="peBgPicker" value="#000000" style="opacity:0;width:0;height:0;position:absolute" oninput="peSetBgColor(this.value)">

              <!-- Hex inputs -->
              <div style="display:flex;gap:4px;margin-bottom:6px">
                <input id="peFgHex" type="text" value="#ffffff" maxlength="7"
                  style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:JetBrains Mono,monospace;font-size:0.65rem;padding:4px 6px;border-radius:4px;outline:none"
                  oninput="peHexInput(this,'fg')" placeholder="FG">
                <input id="peBgHex" type="text" value="#000000" maxlength="7"
                  style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:JetBrains Mono,monospace;font-size:0.65rem;padding:4px 6px;border-radius:4px;outline:none"
                  oninput="peHexInput(this,'bg')" placeholder="BG">
              </div>

              <!-- Opacity slider -->
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
                <span style="font-size:0.55rem;color:var(--muted)">Opacity</span>
                <input type="range" id="peOpacity" min="1" max="255" value="255"
                  style="flex:1;accent-color:var(--accent)" oninput="document.getElementById('peOpacityVal').textContent=Math.round(this.value/255*100)+'%'">
                <span id="peOpacityVal" style="font-size:0.55rem;color:var(--accent3);min-width:28px">100%</span>
              </div>
            </div>

            <!-- Quick palette swatches -->
            <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px">
              <div style="font-size:0.55rem;color:var(--muted);letter-spacing:2px;margin-bottom:8px">QUICK PALETTE</div>
              <div id="peQuickPalette" style="display:grid;grid-template-columns:repeat(5,1fr);gap:3px"></div>
              <button onclick="peAddToQuickPalette()" style="width:100%;margin-top:6px;background:transparent;border:1px dashed var(--border2);color:var(--muted);font-size:0.58rem;padding:3px;border-radius:4px;cursor:pointer" title="Add current FG color">+ Add</button>
            </div>

            <!-- Sprite-palette import -->
            <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px">
              <div style="font-size:0.55rem;color:var(--muted);letter-spacing:2px;margin-bottom:8px">THEME PALETTES</div>
              <select id="pePaletteTheme" style="width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:Space Mono;font-size:0.62rem;padding:5px;border-radius:4px;margin-bottom:6px">
                <option value="gameboy">Game Boy</option>
                <option value="nes">NES Classic</option>
                <option value="pico8">PICO-8</option>
                <option value="endesga32">ENDESGA 32</option>
                <option value="nord">Nord</option>
                <option value="sunset">Sunset</option>
                <option value="neon">Neon City</option>
                <option value="earth">Earthtones</option>
              </select>
              <div id="pePaletteThemeSwatches" style="display:grid;grid-template-columns:repeat(8,1fr);gap:2px"></div>
            </div>

            <!-- Canvas resize -->
            <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px">
              <div style="font-size:0.55rem;color:var(--muted);letter-spacing:2px;margin-bottom:8px">CANVAS SIZE</div>
              <div style="display:flex;gap:4px;align-items:center;margin-bottom:6px">
                <input type="number" id="peResizeW" value="64" min="8" max="512"
                  style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:Space Mono;font-size:0.62rem;padding:4px;border-radius:3px;outline:none">
                <span style="color:var(--muted);font-size:0.65rem">√ó</span>
                <input type="number" id="peResizeH" value="64" min="8" max="512"
                  style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:Space Mono;font-size:0.62rem;padding:4px;border-radius:3px;outline:none">
              </div>
              <button class="btn-sm" onclick="peResizeCanvas()" style="width:100%;font-size:0.6rem">Resize</button>
            </div>

            <!-- Symmetry + grid -->
            <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px">
              <div style="font-size:0.55rem;color:var(--muted);letter-spacing:2px;margin-bottom:8px">OPTIONS</div>
              <label style="display:flex;align-items:center;gap:6px;font-size:0.62rem;color:var(--muted);margin-bottom:5px;cursor:pointer">
                <input type="checkbox" id="peSymX" onchange="pe.sym_x=this.checked"> Mirror X
              </label>
              <label style="display:flex;align-items:center;gap:6px;font-size:0.62rem;color:var(--muted);margin-bottom:5px;cursor:pointer">
                <input type="checkbox" id="peSymY" onchange="pe.sym_y=this.checked"> Mirror Y
              </label>
              <label style="display:flex;align-items:center;gap:6px;font-size:0.62rem;color:var(--muted);margin-bottom:5px;cursor:pointer">
                <input type="checkbox" id="peShowGrid" checked onchange="peToggleGrid(this.checked)"> Show Grid
              </label>
              <label style="display:flex;align-items:center;gap:6px;font-size:0.62rem;color:var(--muted);cursor:pointer">
                <input type="checkbox" id="peAntiAlias" onchange="pe.antialias=this.checked"> Anti-alias
              </label>
            </div>
          </div>

        </div><!-- /pixelEditorRoot -->
      </div><!-- /tab-pixeleditor -->

    </div><!-- /canvas-area -->
  </div><!-- /main-canvas -->


  <!-- ‚ïê‚ïê‚ïê SIDEBAR RIGHT ‚ïê‚ïê‚ïê -->
  <div class="sidebar-right">

    <div class="sb-section">
      <div class="sb-title">Quick Prompts</div>
      <div class="suggestions" id="suggestions">
        <button class="sug-btn" onclick="setSuggestion(this)">pixel warrior fire</button>
        <button class="sug-btn" onclick="setSuggestion(this)">wizard ice magic</button>
        <button class="sug-btn" onclick="setSuggestion(this)">stone dungeon tile</button>
        <button class="sug-btn" onclick="setSuggestion(this)">sci-fi spaceship blue</button>
        <button class="sug-btn" onclick="setSuggestion(this)">gold coin treasure</button>
        <button class="sug-btn" onclick="setSuggestion(this)">health potion red</button>
        <button class="sug-btn" onclick="setSuggestion(this)">dragon boss dark</button>
        <button class="sug-btn" onclick="setSuggestion(this)">neon cyberpunk car</button>
        <button class="sug-btn" onclick="setSuggestion(this)">magic explosion particle</button>
        <button class="sug-btn" onclick="setSuggestion(this)">forest tree environment</button>
        <button class="sug-btn" onclick="setSuggestion(this)">heart health icon</button>
        <button class="sug-btn" onclick="setSuggestion(this)">barrel prop wood</button>
        <button class="sug-btn" onclick="setSuggestion(this)">zombie enemy dark</button>
        <button class="sug-btn" onclick="setSuggestion(this)">ocean water tile</button>
        <button class="sug-btn" onclick="setSuggestion(this)">alien robot sci-fi</button>
      </div>
    </div>

    <div class="sb-section">
      <div class="sb-title">Generation History</div>
      <div class="history-list" id="historyList">
        <div style="font-size:0.62rem;color:var(--muted2);padding:8px">No history yet. Generate your first asset!</div>
      </div>
    </div>

    <div class="sb-section">
      <div class="sb-title">Current Palette</div>
      <div class="pal-preview" id="palPreview"></div>
    </div>

    <div class="sb-section">
      <div class="sb-title">Keyboard Shortcuts</div>
      <div class="shortcut-table">
        <div class="sc-row"><span>Generate</span><span class="sc-key">Ctrl+Enter</span></div>
        <div class="sc-row"><span>Download PNG</span><span class="sc-key">Ctrl+S</span></div>
        <div class="sc-row"><span>Download ZIP</span><span class="sc-key">Ctrl+Shift+S</span></div>
        <div class="sc-row"><span>3D Views</span><span class="sc-key">Alt+3</span></div>
        <div class="sc-row"><span>Clear prompt</span><span class="sc-key">Escape</span></div>
        <div class="sc-row"><span>Variant</span><span class="sc-key">Ctrl+V</span></div>
      </div>
    </div>

  </div><!-- /sidebar-right -->
</div><!-- /app -->


<!-- MODALS -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modalContent">
    <button class="close" onclick="closeModal()">‚úï Close</button>
    <div id="modalBody"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>


<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPRITE! FRONTEND APPLICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const API = '';  // Same origin ‚Äî server.py runs on same host

let state = {
  currentType: 'sprite',
  currentImage: null,
  currentImage64: null,
  current3d: null,
  currentAnim: null,
  currentTilemap: null,
  currentPalette: 'magic',
  history: [],
  animTimer: null,
  animFrames: 0,
  animFrame: 0,
  animImg: null,
};

// ‚îÄ‚îÄ‚îÄ PALETTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PALETTES = {
  fire:    ['#ff3c00','#ff7800','#ffc800','#b41400','#fff5b4','#640a00'],
  ice:     ['#b4e6ff','#64b4ff','#3278dc','#c8f0ff','#ffffff','#143ca0'],
  nature:  ['#227814','#50b428','#96d250','#3c5a1e','#c8e664','#1e3c0a'],
  dark:    ['#140a1e','#3c143c','#641e50','#963264','#c85078','#0a0514'],
  gold:    ['#dcb400','#ffdc32','#b48200','#fff096','#966400','#ffffc8'],
  poison:  ['#50b400','#287800','#78dc1e','#c8ff64','#145000','#b4ff32'],
  ocean:   ['#0050b4','#008cdc','#32c8fa','#00c8c8','#64e6ff','#003282'],
  stone:   ['#50505a','#787882','#a0a0aa','#3c3c46','#c8c8d2','#282832'],
  magic:   ['#7800c8','#b432ff','#500096','#e696ff','#ffc8ff','#280064'],
  neon:    ['#00ff96','#ff0096','#00c8ff','#ffff00','#c800ff','#ff6400'],
  earth:   ['#785028','#a06e3c','#c8965a','#503214','#e6c896','#32190a'],
  blood:   ['#960000','#c81414','#ff3232','#640000','#ff9696','#320000'],
};

function initPaletteGrid() {
  const grid = document.getElementById('paletteGrid');
  grid.innerHTML = '';
  for(const [name, colors] of Object.entries(PALETTES)) {
    const sw = document.createElement('div');
    sw.className = 'pal-swatch' + (name === state.currentPalette ? ' active' : '');
    sw.title = name;
    sw.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[2]} 60%, ${colors[4]} 100%)`;
    sw.onclick = () => {
      state.currentPalette = name;
      document.querySelectorAll('.pal-swatch').forEach(s=>s.classList.remove('active'));
      sw.classList.add('active');
      updatePalPreview(name);
    };
    grid.appendChild(sw);
  }
  updatePalPreview(state.currentPalette);
}

function updatePalPreview(name) {
  const colors = PALETTES[name] || [];
  const el = document.getElementById('palPreview');
  el.innerHTML = colors.map(c=>`<div class="pal-dot" style="background:${c}" title="${c}"></div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(tabId, btn) {
  document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display='none');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+tabId).style.display = '';
  if(btn) btn.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ TYPE SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setType(btn, type) {
  state.currentType = type;
  document.querySelectorAll('.type-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  // Auto-switch tab
  const tabMap = { sprite:'preview', '3d':'3dviews', tilemap:'tilemap', animation:'animation', pack:'pack', iconset:'preview', atlas:'preview' };
  const target = tabMap[type] || 'preview';
  const tabBtns = document.querySelectorAll('.tab');
  tabBtns.forEach(t => { if(t.textContent.trim().toLowerCase() === target || t.onclick.toString().includes(`'${target}'`)) { showTab(target, t); } });
}

// ‚îÄ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generate() {
  const prompt = document.getElementById('prompt').value.trim();
  if(!prompt) { showToast('Please enter a prompt!', 'error'); return; }

  const btn = document.getElementById('generateBtn');
  btn.classList.add('loading');
  btn.textContent = '‚è≥ GENERATING...';

  try {
    const type = state.currentType;
    let suffix = '';
    const cat = document.getElementById('categorySelect').value;
    const sty = document.getElementById('styleSelect').value;
    const sz  = document.getElementById('sizeRange').value;
    let fullPrompt = prompt;
    if(cat) fullPrompt += ' ' + cat;
    if(sty) fullPrompt += ' ' + sty;
    fullPrompt += ' ' + state.currentPalette;
    fullPrompt += ' ' + sz + 'px';

    if(type === 'sprite') {
      await generateSprite(fullPrompt);
    } else if(type === '3d') {
      await generate3d(fullPrompt);
    } else if(type === 'tilemap') {
      await generateTilemap(fullPrompt);
    } else if(type === 'animation') {
      await generateAnimation(fullPrompt);
    } else if(type === 'pack') {
      await generatePack(fullPrompt);
    } else if(type === 'iconset') {
      await generateIconSet(fullPrompt);
    } else if(type === 'atlas') {
      await generateAtlas(fullPrompt);
    }

    showToast('‚úì Asset generated!', 'success');
  } catch(e) {
    showToast('Error: '+e.message, 'error');
    console.error(e);
  } finally {
    btn.classList.remove('loading');
    btn.textContent = '‚ö° GENERATE';
  }
}

async function generateSprite(prompt) {
  const res = await fetch(`${API}/api/generate/sprite`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  displaySprite(data, prompt);
}

async function generate3d(prompt) {
  const res = await fetch(`${API}/api/generate/3d`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  state.current3d = data;
  display3dViews(data);
  // Also show sprite-like first view in preview
  const frontImg = data.views.front;
  displayImageB64(frontImg, prompt, '3D Mesh', '');
  showTab('3dviews', document.querySelector('.tab:nth-child(2)'));
}

async function generateTilemap(prompt) {
  const cols = parseInt(document.getElementById('tilemapCols').value)||4;
  const rows = parseInt(document.getElementById('tilemapRows').value)||4;
  const res = await fetch(`${API}/api/generate/tilemap`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt, cols, rows})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  state.currentTilemap = data.image_b64;
  const wrap = document.getElementById('tilemapWrap');
  wrap.innerHTML = `<img src="data:image/png;base64,${data.image_b64}" style="image-rendering:pixelated;max-width:100%">
    <div style="font-size:0.6rem;color:var(--muted);margin-top:6px">${cols}√ó${rows} tiles ¬∑ ${data.tile_size}px each</div>`;
  document.getElementById('tilemapDlBtn').style.display='';
  showTab('tilemap', document.querySelector('.tab'));
}

async function generateAnimation(prompt) {
  const frames = parseInt(document.getElementById('frameCount').value)||8;
  const res = await fetch(`${API}/api/generate/animation`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt, frames})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  state.currentAnim = data;
  state.animFrames = data.frames;
  state.animFrame = 0;
  const strip = document.getElementById('animStrip');
  strip.innerHTML = `<img id="animSheetImg" src="data:image/png;base64,${data.image_b64}" style="image-rendering:pixelated;max-width:100%">
    <div style="font-size:0.6rem;color:var(--muted);margin-top:4px">${frames} frames ¬∑ ${data.frame_width}px each</div>`;
  document.getElementById('animPlayBtn').style.display='';
  document.getElementById('animDlBtn').style.display='';
  showTab('animation', document.querySelector('.tab'));
}

async function generatePack(prompt) {
  const res = await fetch(`${API}/api/generate/pack`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  const grid = document.getElementById('packGrid');
  const maps = [
    ['Base Sprite','sprite', data.sprite],
    ['Normal Map', 'normal', data.normal],
    ['Emissive',   'emissive', data.emissive],
    ['Roughness',  'roughness', data.roughness],
    ['4√ó Upscaled','upscaled', data.upscaled],
  ];
  // also show tilemap
  grid.innerHTML = maps.map(([lbl,,b64])=>`
    <div class="pack-cell">
      <div class="pack-cell-label">${lbl}</div>
      <div class="pack-cell-img">
        <img src="data:image/png;base64,${b64}" style="image-rendering:pixelated;max-height:80px">
      </div>
    </div>
  `).join('') + `
    <div class="pack-cell" style="cursor:pointer" onclick="downloadZip()">
      <div class="pack-cell-label">‚Üì Full ZIP</div>
      <div class="pack-cell-img" style="font-size:1.5rem">üì¶</div>
    </div>
  `;
  // Store sprite
  state.currentImage64 = data.sprite;
  showTab('pack', document.querySelector('.tab'));
}

async function generateIconSet(prompt) {
  const res = await fetch(`${API}/api/generate/iconset`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  // Show all sizes in preview area
  const wrap = document.getElementById('assetImgWrap');
  wrap.innerHTML = `<div style="display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap;justify-content:center">` +
    Object.entries(data.icons).map(([sz,b64])=>`
      <div style="text-align:center">
        <img src="data:image/png;base64,${b64}" style="image-rendering:pixelated;width:${sz}px;height:${sz}px;max-width:100px;display:block;border:1px solid var(--border);border-radius:3px">
        <div style="font-size:0.55rem;color:var(--muted);margin-top:3px">${sz}px</div>
      </div>
    `).join('') + '</div>';
  document.getElementById('assetTitle').textContent = 'Icon Set';
  document.getElementById('assetMeta').textContent = '16 ¬∑ 32 ¬∑ 64 ¬∑ 128px';
  document.getElementById('assetFooter').style.display='flex';
  state.currentImage64 = Object.values(data.icons).at(-1);
}

async function generateAtlas(prompt) {
  const prompts = prompt.split(',').map(p=>p.trim()).filter(Boolean);
  const usePrompts = prompts.length > 1 ? prompts : ['warrior','wizard','archer','knight','rogue','paladin'];
  const res = await fetch(`${API}/api/generate/atlas`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompts: usePrompts})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  const wrap = document.getElementById('assetImgWrap');
  wrap.innerHTML = `<img src="data:image/png;base64,${data.atlas_b64}" style="image-rendering:pixelated;max-width:100%">`;
  document.getElementById('assetTitle').textContent = 'Texture Atlas';
  document.getElementById('assetMeta').textContent = `${usePrompts.length} sprites packed`;
  document.getElementById('assetFooter').style.display='flex';
  state.currentImage64 = data.atlas_b64;
}

function displaySprite(data, prompt) {
  state.currentImage64 = data.image_b64;
  const info = data.info;
  document.getElementById('assetTitle').textContent = prompt.substring(0,50);
  document.getElementById('assetMeta').textContent = `${info.category} ¬∑ ${info.style} ¬∑ ${data.size}`;
  const wrap = document.getElementById('assetImgWrap');
  wrap.innerHTML = `<img src="data:image/png;base64,${data.image_b64}" style="image-rendering:pixelated;max-width:300px;max-height:300px">`;
  document.getElementById('assetFooter').style.display='flex';
  // Info tags
  const tags = document.getElementById('infoTags');
  tags.style.display='flex';
  tags.innerHTML = [
    `category: <span>${info.category}</span>`,
    `style: <span>${info.style}</span>`,
    `palette: <span>${info.palette}</span>`,
    `size: <span>${data.size}</span>`,
    `seed: <span>${info.seed}</span>`,
  ].map(t=>`<div class="itag">${t}</div>`).join('');
  // Add to history
  addToHistory(prompt, data.image_b64, info);
}

function displayImageB64(b64, prompt, title, meta) {
  const wrap = document.getElementById('assetImgWrap');
  wrap.innerHTML = `<img src="data:image/png;base64,${b64}" style="image-rendering:pixelated;max-width:280px;max-height:280px">`;
  document.getElementById('assetTitle').textContent = title || prompt;
  document.getElementById('assetMeta').textContent = meta;
  state.currentImage64 = b64;
}

function display3dViews(data) {
  const views = data.views;
  for(const [vname, b64] of Object.entries(views)) {
    const cell = document.getElementById(`view-${vname}`);
    if(cell) {
      cell.innerHTML = `<div class="view-label">${vname.toUpperCase()}</div><img src="data:image/png;base64,${b64}" style="width:100%">`;
    }
  }
}

// ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addToHistory(prompt, b64, info) {
  state.history.unshift({prompt, b64, info, ts: Date.now()});
  if(state.history.length > 20) state.history.pop();
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('historyList');
  if(!state.history.length) {
    list.innerHTML = '<div style="font-size:0.62rem;color:var(--muted2);padding:8px">No history yet.</div>';
    return;
  }
  list.innerHTML = state.history.slice(0,12).map((h,i)=>`
    <div class="hist-item" onclick="loadHistory(${i})">
      <img class="hist-thumb" src="data:image/png;base64,${h.b64}">
      <div class="hist-info">
        <div class="hist-prompt">${h.prompt.substring(0,30)}</div>
        <div class="hist-meta">${h.info.category} ¬∑ ${h.info.style}</div>
      </div>
    </div>
  `).join('');
}

function loadHistory(idx) {
  const h = state.history[idx];
  if(!h) return;
  document.getElementById('prompt').value = h.prompt;
  displaySprite({image_b64: h.b64, info: h.info, size: h.info.size+'x'+h.info.size}, h.prompt);
}

// ‚îÄ‚îÄ‚îÄ ADDONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addonNormalMap() {
  if(!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  showToast('Generating normal map...', 'success');
  const res = await fetch(`${API}/api/addon/normalmap`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({image_b64: state.currentImage64})
  });
  const data = await res.json();
  if(data.error) { showToast(data.error,'error'); return; }
  openModal('Normal Map', `<img src="data:image/png;base64,${data.normal_b64}" style="image-rendering:pixelated;width:100%;max-width:256px;border:1px solid var(--border);border-radius:4px">
    <p style="margin-top:10px">Normal map generated for lighting/PBR rendering.</p>
    <button class="btn-sm primary" style="margin-top:8px" onclick="downloadB64('${data.normal_b64}','normal_map.png')">‚Üì Download</button>`);
}

async function addonEmissive() {
  if(!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  showToast('Generating emissive map...', 'success');
  const res = await fetch(`${API}/api/generate/pack`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt: document.getElementById('prompt').value || 'character'})
  });
  const data = await res.json();
  if(data.error) { showToast(data.error,'error'); return; }
  openModal('Emissive Map', `<img src="data:image/png;base64,${data.emissive}" style="image-rendering:pixelated;width:100%;max-width:256px;border:1px solid var(--border);border-radius:4px">
    <button class="btn-sm primary" style="margin-top:10px" onclick="downloadB64('${data.emissive}','emissive_map.png')">‚Üì Download</button>`);
}

async function addonRoughness() {
  if(!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  showToast('Generating roughness map...', 'success');
  const res = await fetch(`${API}/api/addon/normalmap`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({image_b64: state.currentImage64})
  });
  const data = await res.json();
  // Roughness approximation: show as grayscale inverted normal
  openModal('Roughness Map', `<img src="data:image/png;base64,${data.normal_b64}" style="image-rendering:pixelated;width:100%;max-width:256px;filter:grayscale(1) invert(0.3);border:1px solid var(--border);border-radius:4px">
    <p style="margin-top:10px;font-size:0.68rem">Roughness map (grayscale, bright=rough, dark=smooth)</p>
    <button class="btn-sm primary" style="margin-top:8px" onclick="downloadB64('${data.normal_b64}','roughness_map.png')">‚Üì Download</button>`);
}

async function addonUpscale() {
  if(!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  showToast('Upscaling 4√ó...', 'success');
  const res = await fetch(`${API}/api/addon/upscale`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({image_b64: state.currentImage64, factor: 4})
  });
  const data = await res.json();
  if(data.error) { showToast(data.error,'error'); return; }
  openModal('4√ó Upscaled', `<img src="data:image/png;base64,${data.upscaled_b64}" style="image-rendering:pixelated;width:100%;max-width:300px;border:1px solid var(--border);border-radius:4px">
    <p style="margin-top:8px;font-size:0.68rem;color:var(--muted)">Size: ${data.size}</p>
    <button class="btn-sm primary" style="margin-top:8px" onclick="downloadB64('${data.upscaled_b64}','sprite_4x.png')">‚Üì Download</button>`);
}

async function addonShadow() {
  if(!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  // Client-side canvas effect
  const canvas = document.createElement('canvas');
  const img = new Image();
  img.onload = () => {
    canvas.width = img.width; canvas.height = img.height + 20;
    const ctx = canvas.getContext('2d');
    ctx.filter = 'blur(8px) brightness(0)';
    ctx.globalAlpha = 0.5;
    ctx.drawImage(img, 4, 10);
    ctx.filter = 'none';
    ctx.globalAlpha = 1;
    ctx.drawImage(img, 0, 0);
    openModal('Drop Shadow', `<img src="${canvas.toDataURL()}" style="image-rendering:pixelated;max-width:100%;border:1px solid var(--border);border-radius:4px">
      <button class="btn-sm primary" style="margin-top:10px" onclick="downloadDataUrl('${canvas.toDataURL()}','sprite_shadow.png')">‚Üì Download</button>`);
  };
  img.src = `data:image/png;base64,${state.currentImage64}`;
}

async function addonOutline() {
  if(!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  const canvas = document.createElement('canvas');
  const img = new Image();
  img.onload = () => {
    canvas.width = img.width + 4; canvas.height = img.height + 4;
    const ctx = canvas.getContext('2d');
    const offsets = [[-2,0],[2,0],[0,-2],[0,2],[-2,-2],[2,2],[-2,2],[2,-2]];
    ctx.fillStyle = '#ffffff';
    for(const [dx,dy] of offsets) { ctx.drawImage(img, dx+2, dy+2); }
    ctx.globalCompositeOperation = 'destination-out';
    for(const [dx,dy] of offsets) { ctx.drawImage(img, dx+2, dy+2); }
    ctx.globalCompositeOperation = 'source-over';
    ctx.drawImage(img, 2, 2);
    // Actually let's do it properly client-side via CSS filter outline trick
    const canvas2 = document.createElement('canvas');
    canvas2.width = img.width+8; canvas2.height = img.height+8;
    const ctx2 = canvas2.getContext('2d');
    ctx2.shadowColor = '#ffffff';
    ctx2.shadowBlur = 4;
    ctx2.drawImage(img, 4, 4);
    ctx2.shadowBlur = 0;
    ctx2.drawImage(img, 4, 4);
    openModal('Outline Stroke', `<img src="${canvas2.toDataURL()}" style="image-rendering:pixelated;max-width:100%;background:#333;border-radius:4px">
      <button class="btn-sm primary" style="margin-top:10px" onclick="downloadDataUrl('${canvas2.toDataURL()}','sprite_outline.png')">‚Üì Download</button>`);
  };
  img.src = `data:image/png;base64,${state.currentImage64}`;
}

function openPaletteSwap() {
  if(!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  const palOptions = Object.keys(PALETTES).map(p=>`<option value="${p}">${p}</option>`).join('');
  openModal('Palette Swap', `
    <p>Swap the color palette of the current sprite to a completely new one.</p>
    <select id="swapPalSel" style="width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:5px;font-family:Space Mono;margin:10px 0">${palOptions}</select>
    <button class="btn-sm primary" style="width:100%" onclick="runPaletteSwap()">‚ö° Swap Palette</button>
    <div id="swapResult" style="margin-top:12px"></div>
  `);
}

async function runPaletteSwap() {
  const palette = document.getElementById('swapPalSel').value;
  const res = await fetch(`${API}/api/addon/palette_swap`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({image_b64: state.currentImage64, palette})
  });
  const data = await res.json();
  if(data.error) { showToast(data.error,'error'); return; }
  document.getElementById('swapResult').innerHTML = `
    <img src="data:image/png;base64,${data.swapped_b64}" style="image-rendering:pixelated;max-width:200px;border:1px solid var(--border);border-radius:4px">
    <br><button class="btn-sm primary" style="margin-top:8px" onclick="downloadB64('${data.swapped_b64}','sprite_recolored.png')">‚Üì Download</button>
    <button class="btn-sm" style="margin-top:8px;margin-left:6px" onclick="applySwap('${data.swapped_b64}')">Apply</button>
  `;
}

function applySwap(b64) {
  state.currentImage64 = b64;
  document.getElementById('assetImgWrap').innerHTML = `<img src="data:image/png;base64,${b64}" style="image-rendering:pixelated;max-width:300px;max-height:300px">`;
  closeModal();
  showToast('Palette applied!', 'success');
}

function openBatch() {
  showTab('batch', document.querySelector('.tab[onclick*="batch"]'));
}

async function addonAtlas() {
  const prompt = document.getElementById('prompt').value || 'game characters';
  setType(document.querySelector('.type-tab[data-type="atlas"]'), 'atlas');
  await generate();
}

async function addonIconSet() {
  const prompt = document.getElementById('prompt').value || 'icon';
  setType(document.querySelector('.type-tab[data-type="iconset"]'), 'iconset');
  await generate();
}

function openAnimPreview() {
  if(!state.currentAnim) { showToast('Generate an animation first!', 'error'); return; }
  playAnim();
}

// ‚îÄ‚îÄ‚îÄ ANIMATION PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playAnim() {
  if(!state.currentAnim) return;
  const canvas = document.getElementById('animPreviewCanvas');
  document.getElementById('animCanvas').style.display='';
  const ctx = canvas.getContext('2d');
  const fw = state.currentAnim.frame_width;
  const fh = state.currentAnim.frame_height;
  canvas.width = fw; canvas.height = fh;

  if(state.animTimer) { clearInterval(state.animTimer); state.animTimer = null; }

  const img = new Image();
  img.onload = () => {
    state.animImg = img;
    const fps = parseInt(document.getElementById('animFps').value)||8;
    let f = 0;
    state.animTimer = setInterval(()=>{
      ctx.clearRect(0,0,fw,fh);
      ctx.drawImage(img, f*fw, 0, fw, fh, 0, 0, fw, fh);
      f = (f+1) % state.currentAnim.frames;
    }, 1000/fps);
  };
  img.src = `data:image/png;base64,${state.currentAnim.image_b64}`;
}

// ‚îÄ‚îÄ‚îÄ ENGINE EXPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEngineExport(engine) {
  const prompt = document.getElementById('prompt').value || 'MySprite';
  const safeName = prompt.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').substring(0,20) || 'MySprite';
  let code = '', title = '', filename = '';

  if(engine === 'unity') {
    title = '‚¨° Unity ‚Äî C# Import Helper';
    filename = `${safeName}Importer.cs`;
    code = `// Sprite! Unity Import Helper ‚Äî generated by Sprite!
// Place this script in your Editor/ folder.
// Then go to Assets > Sprite! > Import ${safeName}

using UnityEditor;
using UnityEngine;
using System.IO;

public class ${safeName}Importer : Editor
{
    [MenuItem("Assets/Sprite! Import/${safeName}")]
    static void ImportSprites()
    {
        string spritePath = "Assets/Sprites/${safeName}/";
        if (!Directory.Exists(spritePath))
            Directory.CreateDirectory(spritePath);

        // Copy your downloaded PNG files into spritePath, then run this.
        string[] files = Directory.GetFiles(spritePath, "*.png");
        foreach (string f in files)
        {
            TextureImporter ti = AssetImporter.GetAtPath(f) as TextureImporter;
            if (ti == null) continue;
            ti.textureType      = TextureImporterType.Sprite;
            ti.spriteImportMode = SpriteImportMode.Single;
            ti.filterMode       = FilterMode.Point;       // Pixel art
            ti.maxTextureSize   = 512;
            ti.textureCompression = TextureImporterCompression.Uncompressed;
            ti.SaveAndReimport();
            Debug.Log($"Imported: {f}");
        }
        AssetDatabase.Refresh();
        Debug.Log("‚úì Sprite! Import Complete");
    }

    [MenuItem("Assets/Sprite! Import/Setup ${safeName} Animator")]
    static void SetupAnimator()
    {
        // Creates a simple Animator Controller for the 8-frame walk cycle sheet
        string animPath = "Assets/Animations/${safeName}/";
        if (!Directory.Exists(animPath))
            Directory.CreateDirectory(animPath);

        var ctrl = UnityEditor.Animations.AnimatorController.CreateAnimatorControllerAtPath(
            animPath + "${safeName}Controller.controller");
        var root = ctrl.layers[0].stateMachine;

        // Add idle and walk states
        var idle = root.AddState("Idle");
        var walk = root.AddState("Walk");
        ctrl.AddParameter("Moving", AnimatorControllerParameterType.Bool);

        var toWalk = idle.AddTransition(walk);
        toWalk.AddCondition(UnityEditor.Animations.AnimatorConditionMode.If, 0, "Moving");

        AssetDatabase.SaveAssets();
        Debug.Log("‚úì Animator Controller created at " + animPath);
    }
}`;
  } else if(engine === 'unreal') {
    title = '‚óà Unreal Engine ‚Äî Python Import Script';
    filename = `import_${safeName.toLowerCase()}.py`;
    code = `# Sprite! Unreal Engine Import Script ‚Äî generated by Sprite!
# Run via: Tools > Execute Python Script, or place in Project/Content/Python/

import unreal
import os

SPRITE_FOLDER = r"C:\\YourProject\\SpriteAssets\\${safeName}"  # CHANGE THIS
DEST_PATH     = "/Game/Sprites/${safeName}/"

def import_sprites():
    task_list = []
    asset_tools = unreal.AssetToolsHelpers.get_asset_tools()

    for fname in os.listdir(SPRITE_FOLDER):
        if not fname.lower().endswith('.png'):
            continue
        fpath = os.path.join(SPRITE_FOLDER, fname)
        name  = os.path.splitext(fname)[0]

        task = unreal.AssetImportTask()
        task.path          = fpath
        task.destination_path = DEST_PATH
        task.destination_name = name
        task.replace_existing = True
        task.automated        = True
        task.save             = True

        # Texture settings
        options = unreal.TextureFactory()
        task.options = options
        task_list.append(task)

    asset_tools.import_asset_tasks(task_list)
    unreal.log(f"‚úì Sprite! Imported {len(task_list)} textures to {DEST_PATH}")

def setup_paper2d_sprites():
    """Convert imported textures to Paper2D sprites."""
    try:
        import unreal
        ar = unreal.AssetRegistryHelpers.get_asset_registry()
        assets = ar.get_assets_by_path(DEST_PATH, recursive=True)
        editor = unreal.get_editor_subsystem(unreal.AssetEditorSubsystem)
        for a in assets:
            if a.asset_class_path.asset_name == "Texture2D":
                unreal.log(f"  Processing: {a.asset_name}")
    except Exception as e:
        unreal.log_warning(f"Paper2D setup skipped: {e}")

if __name__ == "__main__":
    import_sprites()
    setup_paper2d_sprites()
    unreal.log("‚úì Sprite! Unreal Import Complete!")
`;
  } else if(engine === 'godot') {
    title = '‚óâ Godot ‚Äî GDScript Import Helper';
    filename = `${safeName.toLowerCase()}_importer.gd`;
    code = `# Sprite! Godot Import Script ‚Äî generated by Sprite!
# Attach to an EditorScript node or run from Tools > Script Editor

@tool
extends EditorScript

const SPRITE_DIR = "res://sprites/${safeName.toLowerCase()}/"
const ANIM_FRAMES = 8
const FRAME_WIDTH = 64   # Match your sprite size

func _run():
    print("Sprite! Godot Importer ‚Äî Starting...")
    var dir = DirAccess.open("res://")
    if not dir.dir_exists(SPRITE_DIR):
        dir.make_dir_recursive(SPRITE_DIR)
        print("Created directory: ", SPRITE_DIR)

    # Copy your downloaded sprites into SPRITE_DIR, then run this.
    # This will set up import configs and create animation resources.

    # Configure texture imports for pixel art
    _configure_pixel_art_imports()

    # Create an AnimationPlayer resource for the walk cycle
    _create_animation_resource()

    print("‚úì Sprite! Import Complete!")

func _configure_pixel_art_imports():
    # Set filter=nearest for all sprites in our folder
    var d = DirAccess.open(SPRITE_DIR)
    if not d: return
    d.list_dir_begin()
    var fname = d.get_next()
    while fname != "":
        if fname.ends_with(".png"):
            var full = SPRITE_DIR + fname
            # Godot auto-detects via .import files ‚Äî override via ProjectSettings
            print("  Configuring: ", full)
        fname = d.get_next()

func _create_animation_resource():
    var sprite_sheet = load(SPRITE_DIR + "animation_sheet.png")
    if not sprite_sheet:
        print("  animation_sheet.png not found ‚Äî skipping animation setup")
        return

    var frames = SpriteFrames.new()
    frames.add_animation("walk")
    frames.set_animation_loop("walk", true)
    frames.set_animation_speed("walk", 8.0)

    for i in range(ANIM_FRAMES):
        var atlas = AtlasTexture.new()
        atlas.atlas = sprite_sheet
        atlas.region = Rect2(i * FRAME_WIDTH, 0, FRAME_WIDTH, FRAME_WIDTH)
        frames.add_frame("walk", atlas)

    ResourceSaver.save(frames, SPRITE_DIR + "${safeName.toLowerCase()}_frames.tres")
    print("  ‚úì SpriteFrames saved: ", SPRITE_DIR + "${safeName.toLowerCase()}_frames.tres")
`;
  } else if(engine === 'gamemaker') {
    title = '‚óÜ GameMaker ‚Äî GML Import Script';
    filename = `scr_import_${safeName.toLowerCase()}.gml`;
    code = `/// @description Sprite! GameMaker Import Script ‚Äî generated by Sprite!
/// @function scr_import_${safeName}
///
/// USAGE:
/// 1. Place your downloaded PNGs in your game's working directory
///    (typically: C:\\Users\\YourName\\Documents\\GameMaker\\Projects\\YourGame\\sprites)
/// 2. Copy this script into your GameMaker project
/// 3. Call scr_import_${safeName}() from a Create or Room Start event
/// 4. Sprites will be loaded at runtime from disk

function scr_import_${safeName}() {
    // --- Configuration ---
    var sprite_dir = working_directory + "sprites/${safeName.toLowerCase()}/";
    var frame_w = 64;   // Match your sprite size
    var frame_h = 64;
    var anim_frames = 8;

    show_debug_message("Sprite! GameMaker Importer ‚Äî Loading ${safeName}...");

    // Load base sprite
    var spr_main = sprite_add(sprite_dir + "sprite.png", 1, true, true, 0, 0);
    if (spr_main >= 0) {
        sprite_set_offset(spr_main, frame_w / 2, frame_h);
        show_debug_message("  ‚úì Loaded: sprite.png as index " + string(spr_main));
        global.spr_${safeName.toLowerCase()} = spr_main;
    }

    // Load animation sheet (8 frames horizontal strip)
    var spr_anim = sprite_add(sprite_dir + "animation_sheet.png", anim_frames, true, true,
                              frame_w / 2, frame_h);
    if (spr_anim >= 0) {
        image_speed = 0.125;  // 8fps at room speed 60
        show_debug_message("  ‚úì Loaded: animation_sheet.png (" + string(anim_frames) + " frames)");
        global.spr_${safeName.toLowerCase()}_anim = spr_anim;
    }

    // Load normal map (for shader use)
    var spr_normal = sprite_add(sprite_dir + "normal_map.png", 1, false, false, 0, 0);
    if (spr_normal >= 0) {
        global.spr_${safeName.toLowerCase()}_normal = spr_normal;
        show_debug_message("  ‚úì Loaded: normal_map.png");
    }

    // Load tilemap sheet
    var spr_tiles = sprite_add(sprite_dir + "tilemap_sheet.png", 1, false, false, 0, 0);
    if (spr_tiles >= 0) {
        // Create a tileset from the sheet
        global.spr_${safeName.toLowerCase()}_tiles = spr_tiles;
        show_debug_message("  ‚úì Loaded: tilemap_sheet.png");
    }

    show_debug_message("‚úì Sprite! Import complete for ${safeName}!");
    return global.spr_${safeName.toLowerCase()};
}

/// Example usage in an object's Create event:
///
///   var my_sprite = scr_import_${safeName}();
///   sprite_index = global.spr_${safeName.toLowerCase()}_anim;
`;
  }

  openModal(title, `
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <button class="btn-sm primary" onclick="downloadText(document.querySelector('#modalBody pre').textContent, '${filename}')">‚Üì Download ${filename}</button>
      <button class="btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('#modalBody pre').textContent);showToast('Copied!','success')">‚ßâ Copy</button>
    </div>
    <pre style="max-height:400px;overflow:auto">${escHtml(code)}</pre>
  `);
}

// ‚îÄ‚îÄ‚îÄ BATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runBatch() {
  const raw = document.getElementById('batchPromptsMain').value;
  const prompts = raw.split('\n').map(p=>p.trim()).filter(Boolean);
  if(!prompts.length) { showToast('Enter prompts, one per line','error'); return; }

  const grid = document.getElementById('batchResultsMain');
  grid.innerHTML = `<div style="color:var(--muted);font-size:0.7rem;grid-column:1/-1;padding:12px" class="pulse">Generating ${prompts.length} sprites...</div>`;

  const res = await fetch(`${API}/api/addon/batch`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompts})
  });
  const data = await res.json();
  if(data.error) { showToast(data.error,'error'); return; }

  grid.innerHTML = data.results.map((r,i)=>`
    <div class="batch-item">
      ${r.image_b64 ? `<img src="data:image/png;base64,${r.image_b64}" onclick="batchSelect(${i})">` : '<div style="height:60px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;color:#f87171">Error</div>'}
      <div class="batch-item-lbl" title="${r.prompt}">${r.prompt}</div>
    </div>
  `).join('');

  // Store batch
  window._batchData = data.results;
  showToast(`‚úì ${data.results.length} sprites generated!`, 'success');
}

function batchSelect(i) {
  const r = (window._batchData||[])[i];
  if(!r||!r.image_b64) return;
  state.currentImage64 = r.image_b64;
  document.getElementById('prompt').value = r.prompt;
  displaySprite({image_b64: r.image_b64, info: r.info, size: r.info.size+'x'+r.info.size}, r.prompt);
  showTab('preview', document.querySelector('.tab'));
  showToast('Sprite loaded!','success');
}

// ‚îÄ‚îÄ‚îÄ DOWNLOADS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function downloadCurrent() {
  if(!state.currentImage64) { showToast('Nothing to download yet!','error'); return; }
  downloadB64(state.currentImage64, 'sprite.png');
}

function downloadB64(b64, filename) {
  const a = document.createElement('a');
  a.href = 'data:image/png;base64,'+b64;
  a.download = filename;
  a.click();
  showToast('‚Üì Downloaded: '+filename, 'success');
}

function downloadDataUrl(url, filename) {
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  showToast('‚Üì Downloaded: '+filename, 'success');
}

function downloadText(text, filename) {
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename; a.click();
  showToast('‚Üì Downloaded: '+filename, 'success');
}

async function downloadZip() {
  const prompt = document.getElementById('prompt').value || 'game asset';
  showToast('Building ZIP package...', 'success');
  const res = await fetch(`${API}/api/download/zip`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt, include_3d: true})
  });
  if(!res.ok) { showToast('ZIP generation failed','error'); return; }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='sprite_pack.zip'; a.click();
  showToast('‚Üì Full pack downloaded!', 'success');
}

function downloadAnim() {
  if(!state.currentAnim) return;
  downloadB64(state.currentAnim.image_b64, 'animation_sheet.png');
}

function downloadTilemap() {
  if(!state.currentTilemap) return;
  downloadB64(state.currentTilemap, 'tilemap_sheet.png');
}

function download3dObj() {
  if(!state.current3d) { showToast('Generate a 3D asset first!','error'); return; }
  downloadText(state.current3d.obj, 'model.obj');
}

function download3dMtl() {
  if(!state.current3d) { showToast('Generate a 3D asset first!','error'); return; }
  downloadText(state.current3d.mtl, 'model.mtl');
}

async function copyToClipboard() {
  if(!state.currentImage64) return;
  try {
    const blob = await (await fetch('data:image/png;base64,'+state.currentImage64)).blob();
    await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
    showToast('Copied to clipboard!', 'success');
  } catch { showToast('Copy failed ‚Äî try Download instead', 'error'); }
}

async function addVariant() {
  const prompt = document.getElementById('prompt').value;
  if(!prompt) return;
  // Slightly different seed by appending " variant"
  document.getElementById('prompt').value = prompt + ' variant';
  await generate();
  document.getElementById('prompt').value = prompt;
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(title, body) {
  document.getElementById('modalBody').innerHTML = `<h2>${title}</h2>${body}`;
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal(e) {
  if(e && e.target !== document.getElementById('modalOverlay')) return;
  document.getElementById('modalOverlay').classList.remove('open');
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type='') {
  const cont = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  cont.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .4s'; setTimeout(()=>t.remove(),400); }, 2500);
}

// ‚îÄ‚îÄ‚îÄ SUGGESTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSuggestion(btn) {
  document.getElementById('prompt').value = btn.textContent;
  generate();
}

// ‚îÄ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if(e.key === 'Enter' && (e.ctrlKey||e.metaKey)) generate();
  if(e.key === 's' && (e.ctrlKey||e.metaKey) && !e.shiftKey) { e.preventDefault(); downloadCurrent(); }
  if(e.key === 'S' && (e.ctrlKey||e.metaKey) && e.shiftKey) { e.preventDefault(); downloadZip(); }
  if(e.key === '3' && e.altKey) { showTab('3dviews', document.querySelector('.tab:nth-child(2)')); }
  if(e.key === 'Escape') {
    if(document.getElementById('modalOverlay').classList.contains('open')) closeModal();
    else document.getElementById('prompt').value = '';
  }
});

// ‚îÄ‚îÄ‚îÄ UTIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initPaletteGrid();
showTab('preview', document.querySelector('.tab'));

// Check server health
fetch(`${API}/api/health`).then(r=>r.json()).then(d=>{
  showToast('‚úì Sprite! ready ‚Äî '+d.version, 'success');
}).catch(()=>{
  showToast('‚ö† Server offline ‚Äî run: python3 server.py', 'error');
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPRITE! PIXEL EDITOR
//  Full-featured pixel art editor with brushes, tools, undo, etc.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const pe = {
  canvas: null, ctx: null,
  width: 64, height: 64,
  zoom: 8,
  tool: 'pencil',
  brushSize: 1,
  fgColor: '#ffffff',
  bgColor: '#000000',
  opacity: 255,
  sym_x: false,
  sym_y: false,
  showGrid: true,
  antialias: false,
  drawing: false,
  lastX: -1, lastY: -1,
  undoStack: [],
  redoStack: [],
  MAX_UNDO: 40,
  lineStart: null,
  rectStart: null,
  circleStart: null,
  selectStart: null,
  selection: null,
  initialized: false,
  quickPalette: ['#ff5f1f','#a855f7','#22d3ee','#22c55e','#f59e0b','#ef4444','#ffffff','#000000','#64748b','#0ea5e9'],
  themePalettes: {
    gameboy:  ['#0f380f','#306230','#8bac0f','#9bbc0f'],
    nes:      ['#000000','#fcfcfc','#f8f8f8','#bcbcbc','#7c7c7c','#a4e4fc','#3cbcfc','#0078f8','#0000fc','#b8b8f8','#6888fc','#0058f8','#00b800','#b8f818','#58d854','#58f898','#fcfcfc','#f8d8a8','#e0a878','#f87858','#d82800','#f83800','#e45c10','#ac7c00','#503000','#007800','#006800','#005800','#004058','#000000','#ffffff','#fffce8'],
    pico8:    ['#000000','#1d2b53','#7e2553','#008751','#ab5236','#5f574f','#c2c3c7','#fff1e8','#ff004d','#ffa300','#ffec27','#00e436','#29adff','#83769c','#ff77a8','#ffccaa'],
    endesga32:['#be4a2f','#d77643','#ead4aa','#e4a672','#b86f50','#733e39','#3e2731','#a22633','#e43b44','#f77622','#feae34','#fee761','#63c74d','#3e8948','#265c42','#193c3e','#124e89','#0099db','#2ce8f5','#ffffff','#c0cbdc','#8b9bb4','#5a6988','#3a4466','#262b44','#181425','#ff0044','#68386c','#b55088','#f6757a','#e8b796','#c28569'],
    nord:     ['#2e3440','#3b4252','#434c5e','#4c566a','#d8dee9','#e5e9f0','#eceff4','#8fbcbb','#88c0d0','#81a1c1','#5e81ac','#bf616a','#d08770','#ebcb8b','#a3be8c','#b48ead'],
    sunset:   ['#0d0221','#0a0133','#261447','#6b0f1a','#b91372','#f1295f','#fe5100','#ff8c00','#ffc200','#f9f9f9'],
    neon:     ['#0a0a0f','#1a0a2e','#16213e','#0f3460','#533483','#e94560','#ff6b6b','#feca57','#48dbfb','#ff9ff3','#00d2d3','#ffffff'],
    earth:    ['#3b1f0f','#5c3317','#8b6343','#c49a6c','#e8c99a','#f5e6d3','#2d5016','#4a7c59','#6baa7a','#8fbc8f','#c8e6c9','#ffffff'],
  },
};

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initPixelEditor() {
  if (pe.initialized) return;
  pe.initialized = true;

  pe.canvas = document.getElementById('peCanvas');
  pe.ctx = pe.canvas.getContext('2d', { willReadFrequently: true });

  peSetCanvasSize(64, 64);
  peFillCanvas('#000000');

  // Mouse events
  pe.canvas.addEventListener('mousedown', peMouseDown);
  pe.canvas.addEventListener('mousemove', peMouseMove);
  pe.canvas.addEventListener('mouseup',   peMouseUp);
  pe.canvas.addEventListener('mouseleave',peMouseUp);
  pe.canvas.addEventListener('contextmenu', e => { e.preventDefault(); pe._useRightClick = true; });

  // Touch support
  pe.canvas.addEventListener('touchstart', e => { e.preventDefault(); const t=e.touches[0]; peMouseDown(toMouseEvt(t)); }, {passive:false});
  pe.canvas.addEventListener('touchmove',  e => { e.preventDefault(); const t=e.touches[0]; peMouseMove(toMouseEvt(t)); }, {passive:false});
  pe.canvas.addEventListener('touchend',   e => { peMouseUp(e); }, {passive:false});

  // Keyboard shortcuts
  document.addEventListener('keydown', peKeyDown);

  // Init palettes
  peRenderQuickPalette();
  peLoadThemePalette('gameboy');
  document.getElementById('pePaletteTheme').addEventListener('change', e => peLoadThemePalette(e.target.value));

  // Init color swatches
  peSetFgColor('#ffffff');
  peSetBgColor('#000000');

  // Push initial state
  pePushUndo();

  peRender();
  console.log('[Sprite!] Pixel Editor ready');
}

function toMouseEvt(touch) {
  const rect = pe.canvas.getBoundingClientRect();
  return { clientX: touch.clientX, clientY: touch.clientY, buttons:1, _touch:true };
}

function peSetCanvasSize(w, h) {
  pe.width = w; pe.height = h;

  // Save existing image data
  let saved = null;
  if (pe.canvas.width > 0 && pe.canvas.height > 0) {
    try { saved = pe.ctx.getImageData(0, 0, pe.canvas.width, pe.canvas.height); } catch(e){}
  }

  pe.canvas.width  = w;
  pe.canvas.height = h;
  pe.canvas.style.width  = (w * pe.zoom) + 'px';
  pe.canvas.style.height = (h * pe.zoom) + 'px';

  // Restore
  if (saved) pe.ctx.putImageData(saved, 0, 0);

  document.getElementById('peCanvasSize').textContent = w + '√ó' + h + ' px';
  document.getElementById('peResizeW').value = w;
  document.getElementById('peResizeH').value = h;
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peRender() {
  // The canvas IS the pixel data ‚Äî no extra render needed.
  // Grid overlay is drawn on a secondary canvas overlay.
  if (!pe.showGrid) return;
  peDrawGrid();
}

function peDrawGrid() {
  const wrap = document.getElementById('peCanvasWrap');
  let gridCanvas = document.getElementById('peGridOverlay');
  if (!gridCanvas) {
    gridCanvas = document.createElement('canvas');
    gridCanvas.id = 'peGridOverlay';
    gridCanvas.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;image-rendering:pixelated;';
    wrap.appendChild(gridCanvas);
  }
  const w = pe.width * pe.zoom;
  const h = pe.height * pe.zoom;
  gridCanvas.width  = w;
  gridCanvas.height = h;
  gridCanvas.style.width  = w + 'px';
  gridCanvas.style.height = h + 'px';

  const gc = gridCanvas.getContext('2d');
  gc.clearRect(0, 0, w, h);
  if (pe.zoom < 3) return; // Don't draw grid when too zoomed out

  gc.strokeStyle = 'rgba(255,255,255,0.07)';
  gc.lineWidth = 1;
  for (let x = 0; x <= pe.width; x++) {
    gc.beginPath(); gc.moveTo(x*pe.zoom, 0); gc.lineTo(x*pe.zoom, h); gc.stroke();
  }
  for (let y = 0; y <= pe.height; y++) {
    gc.beginPath(); gc.moveTo(0, y*pe.zoom); gc.lineTo(w, y*pe.zoom); gc.stroke();
  }
}

function peToggleGrid(on) {
  pe.showGrid = on;
  const ov = document.getElementById('peGridOverlay');
  if (ov) ov.style.display = on ? '' : 'none';
  if (on) peDrawGrid();
}

// ‚îÄ‚îÄ‚îÄ UNDO / REDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pePushUndo() {
  const snap = pe.ctx.getImageData(0, 0, pe.width, pe.height);
  pe.undoStack.push(snap);
  if (pe.undoStack.length > pe.MAX_UNDO) pe.undoStack.shift();
  pe.redoStack = [];
}

function peUndo() {
  if (pe.undoStack.length <= 1) return;
  pe.redoStack.push(pe.undoStack.pop());
  const snap = pe.undoStack[pe.undoStack.length - 1];
  pe.ctx.putImageData(snap, 0, 0);
  peDrawGrid();
}

function peRedo() {
  if (!pe.redoStack.length) return;
  const snap = pe.redoStack.pop();
  pe.undoStack.push(snap);
  pe.ctx.putImageData(snap, 0, 0);
  peDrawGrid();
}

// ‚îÄ‚îÄ‚îÄ MOUSE EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peGetPixelCoord(e) {
  const rect = pe.canvas.getBoundingClientRect();
  const scaleX = pe.canvas.width  / rect.width;
  const scaleY = pe.canvas.height / rect.height;
  const x = Math.floor((e.clientX - rect.left) * scaleX);
  const y = Math.floor((e.clientY - rect.top)  * scaleY);
  return { x: Math.max(0,Math.min(pe.width-1,x)), y: Math.max(0,Math.min(pe.height-1,y)) };
}

function peMouseDown(e) {
  pe.drawing = true;
  pe._useRightClick = e.button === 2;
  const {x, y} = peGetPixelCoord(e);
  pe.lastX = x; pe.lastY = y;
  pePushUndo();

  if (pe.tool === 'fill') {
    peFill(x, y, peActiveColor());
  } else if (pe.tool === 'eyedropper') {
    pePickColor(x, y);
  } else if (pe.tool === 'line') {
    pe.lineStart = {x, y};
    pe._lineSnapshot = pe.ctx.getImageData(0, 0, pe.width, pe.height);
  } else if (pe.tool === 'rect') {
    pe.rectStart = {x, y};
    pe._rectSnapshot = pe.ctx.getImageData(0, 0, pe.width, pe.height);
  } else if (pe.tool === 'circle') {
    pe.circleStart = {x, y};
    pe._circleSnapshot = pe.ctx.getImageData(0, 0, pe.width, pe.height);
  } else if (pe.tool === 'select') {
    pe.selectStart = {x, y};
    pe.selection = null;
  } else {
    pePaintAt(x, y);
  }
}

function peMouseMove(e) {
  const {x, y} = peGetPixelCoord(e);
  document.getElementById('peCursorPos').textContent = `x:${x} y:${y}`;

  if (!pe.drawing) return;

  if (pe.tool === 'line' && pe.lineStart) {
    pe.ctx.putImageData(pe._lineSnapshot, 0, 0);
    peDrawLine(pe.lineStart.x, pe.lineStart.y, x, y);
    peDrawGrid();
  } else if (pe.tool === 'rect' && pe.rectStart) {
    pe.ctx.putImageData(pe._rectSnapshot, 0, 0);
    peDrawRect(pe.rectStart.x, pe.rectStart.y, x, y);
    peDrawGrid();
  } else if (pe.tool === 'circle' && pe.circleStart) {
    pe.ctx.putImageData(pe._circleSnapshot, 0, 0);
    peDrawCircle(pe.circleStart.x, pe.circleStart.y, x, y);
    peDrawGrid();
  } else if (pe.tool === 'select' && pe.selectStart) {
    pe.selection = {
      x: Math.min(pe.selectStart.x, x), y: Math.min(pe.selectStart.y, y),
      w: Math.abs(x - pe.selectStart.x)+1, h: Math.abs(y - pe.selectStart.y)+1
    };
    peShowSelection();
  } else if (pe.tool !== 'fill' && pe.tool !== 'eyedropper') {
    if (x !== pe.lastX || y !== pe.lastY) {
      peDrawLineTo(pe.lastX, pe.lastY, x, y);
      pe.lastX = x; pe.lastY = y;
    }
  }
}

function peMouseUp(e) {
  if (!pe.drawing) return;
  pe.drawing = false;
  pe._useRightClick = false;
  pe.lineStart = pe.rectStart = pe.circleStart = null;
  pe._lineSnapshot = pe._rectSnapshot = pe._circleSnapshot = null;
}

// ‚îÄ‚îÄ‚îÄ PAINT PRIMITIVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peActiveColor() {
  const hex = pe._useRightClick ? pe.bgColor : pe.fgColor;
  return peHexToRgba(hex, pe.opacity);
}

function pePaintAt(px, py) {
  const col = peActiveColor();
  const half = Math.floor((pe.brushSize - 1) / 2);

  const paintPixel = (x, y) => {
    if (x < 0 || y < 0 || x >= pe.width || y >= pe.height) return;
    if (pe.tool === 'eraser') {
      pe.ctx.clearRect(x, y, 1, 1);
    } else {
      pe.ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${col.a/255})`;
      pe.ctx.fillRect(x, y, 1, 1);
    }
  };

  const applyBrush = (cx, cy) => {
    if (pe.brushSize === 1) {
      paintPixel(cx, cy);
      return;
    }
    if (pe.tool === 'brush') {
      // Round brush
      for (let dy = -half; dy <= half; dy++) {
        for (let dx = -half; dx <= half; dx++) {
          if (dx*dx + dy*dy <= half*half + half) paintPixel(cx+dx, cy+dy);
        }
      }
    } else {
      // Square brush
      for (let dy = -half; dy <= half; dy++)
        for (let dx = -half; dx <= half; dx++)
          paintPixel(cx+dx, cy+dy);
    }
  };

  applyBrush(px, py);

  // Symmetry
  if (pe.sym_x) applyBrush(pe.width - 1 - px, py);
  if (pe.sym_y) applyBrush(px, pe.height - 1 - py);
  if (pe.sym_x && pe.sym_y) applyBrush(pe.width - 1 - px, pe.height - 1 - py);
}

function peDrawLineTo(x0, y0, x1, y1) {
  // Bresenham line from last pos to current, paint each step
  let dx = Math.abs(x1-x0), dy = Math.abs(y1-y0);
  let sx = x0<x1?1:-1, sy = y0<y1?1:-1, err = dx-dy;
  let x=x0, y=y0;
  while(true) {
    pePaintAt(x, y);
    if (x===x1 && y===y1) break;
    let e2 = 2*err;
    if (e2 > -dy) { err-=dy; x+=sx; }
    if (e2 < dx)  { err+=dx; y+=sy; }
  }
}

function peDrawLine(x0, y0, x1, y1) {
  peDrawLineTo(x0, y0, x1, y1);
}

function peDrawRect(x0, y0, x1, y1) {
  const lx=Math.min(x0,x1), rx=Math.max(x0,x1);
  const ty=Math.min(y0,y1), by=Math.max(y0,y1);
  for(let x=lx;x<=rx;x++) { pePaintAt(x,ty); pePaintAt(x,by); }
  for(let y=ty;y<=by;y++) { pePaintAt(lx,y); pePaintAt(rx,y); }
}

function peDrawCircle(x0, y0, x1, y1) {
  const cx=(x0+x1)/2, cy=(y0+y1)/2;
  const rx=Math.abs(x1-x0)/2, ry=Math.abs(y1-y0)/2;
  const steps = Math.max(rx,ry) * 8;
  for(let i=0;i<steps;i++) {
    const a = (i/steps)*Math.PI*2;
    const x = Math.round(cx+rx*Math.cos(a));
    const y = Math.round(cy+ry*Math.sin(a));
    pePaintAt(x, y);
  }
}

// ‚îÄ‚îÄ‚îÄ FILL (FLOOD FILL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peFill(startX, startY, newColor) {
  const imageData = pe.ctx.getImageData(0, 0, pe.width, pe.height);
  const data = imageData.data;
  const idx = (y, x) => (y * pe.width + x) * 4;

  const si = idx(startY, startX);
  const tr = data[si], tg = data[si+1], tb = data[si+2], ta = data[si+3];

  // If same color, skip
  if (tr===newColor.r && tg===newColor.g && tb===newColor.b && ta===newColor.a) return;

  const matches = (i) => data[i]===tr && data[i+1]===tg && data[i+2]===tb && data[i+3]===ta;
  const paint   = (i) => { data[i]=newColor.r; data[i+1]=newColor.g; data[i+2]=newColor.b; data[i+3]=newColor.a; };

  const stack = [[startX, startY]];
  const visited = new Uint8Array(pe.width * pe.height);
  visited[startY*pe.width+startX] = 1;

  while (stack.length) {
    const [x, y] = stack.pop();
    const i = idx(y, x);
    if (!matches(i)) continue;
    paint(i);
    const neighbors = [[x-1,y],[x+1,y],[x,y-1],[x,y+1]];
    for (const [nx,ny] of neighbors) {
      if (nx>=0&&nx<pe.width&&ny>=0&&ny<pe.height&&!visited[ny*pe.width+nx]) {
        visited[ny*pe.width+nx]=1;
        stack.push([nx,ny]);
      }
    }
  }
  pe.ctx.putImageData(imageData, 0, 0);
}

// ‚îÄ‚îÄ‚îÄ EYEDROPPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pePickColor(x, y) {
  const d = pe.ctx.getImageData(x, y, 1, 1).data;
  const hex = '#' + [d[0],d[1],d[2]].map(v=>v.toString(16).padStart(2,'0')).join('');
  if (pe._useRightClick) peSetBgColor(hex);
  else peSetFgColor(hex);
}

// ‚îÄ‚îÄ‚îÄ COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peSetFgColor(hex) {
  pe.fgColor = hex;
  document.getElementById('peFgSwatch').style.background = hex;
  document.getElementById('peFgPicker').value = hex;
  document.getElementById('peFgHex').value = hex;
}

function peSetBgColor(hex) {
  pe.bgColor = hex;
  document.getElementById('peBgSwatch').style.background = hex;
  document.getElementById('peBgPicker').value = hex;
  document.getElementById('peBgHex').value = hex;
}

function peSwapColors() {
  const tmp = pe.fgColor;
  peSetFgColor(pe.bgColor);
  peSetBgColor(tmp);
}

function peHexInput(input, which) {
  let v = input.value.trim();
  if (!v.startsWith('#')) v = '#' + v;
  if (/^#[0-9a-fA-F]{6}$/.test(v)) {
    if (which === 'fg') peSetFgColor(v);
    else peSetBgColor(v);
  }
}

function peHexToRgba(hex, alpha=255) {
  const r = parseInt(hex.slice(1,3),16)||0;
  const g = parseInt(hex.slice(3,5),16)||0;
  const b = parseInt(hex.slice(5,7),16)||0;
  return {r,g,b,a:alpha};
}

// ‚îÄ‚îÄ‚îÄ TOOLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peTool(name, btn) {
  pe.tool = name;
  document.querySelectorAll('.pe-tool').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.getElementById('peCurrentTool').textContent = name;
  // Update cursor class
  pe.canvas.className = '';
  if (name==='eraser') pe.canvas.classList.add('cursor-eraser');
  else if (name==='fill') pe.canvas.classList.add('cursor-fill');
  else if (name==='eyedropper') pe.canvas.classList.add('cursor-eyedropper');
}

function peBrushSize(size, btn) {
  pe.brushSize = size;
  document.querySelectorAll('.pe-bs').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ ZOOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peZoom(delta) {
  pe.zoom = Math.max(1, Math.min(32, pe.zoom + delta));
  pe.canvas.style.width  = (pe.width  * pe.zoom) + 'px';
  pe.canvas.style.height = (pe.height * pe.zoom) + 'px';
  document.getElementById('peZoomLabel').textContent = pe.zoom + '√ó';
  peDrawGrid();
}

function peZoomFit() {
  const wrap = document.getElementById('peCanvasWrap');
  const maxW = wrap.clientWidth  - 20;
  const maxH = wrap.clientHeight - 20;
  pe.zoom = Math.max(1, Math.min(Math.floor(maxW/pe.width), Math.floor(maxH/pe.height)));
  pe.canvas.style.width  = (pe.width  * pe.zoom) + 'px';
  pe.canvas.style.height = (pe.height * pe.zoom) + 'px';
  document.getElementById('peZoomLabel').textContent = pe.zoom + '√ó';
  peDrawGrid();
}

// ‚îÄ‚îÄ‚îÄ CANVAS OPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peFillCanvas(hex) {
  pe.ctx.fillStyle = hex;
  pe.ctx.fillRect(0, 0, pe.width, pe.height);
}

function peClearCanvas() {
  pePushUndo();
  pe.ctx.clearRect(0, 0, pe.width, pe.height);
  peDrawGrid();
}

function peResizeCanvas() {
  const w = parseInt(document.getElementById('peResizeW').value) || 64;
  const h = parseInt(document.getElementById('peResizeH').value) || 64;
  pePushUndo();
  // Save old data
  const old = pe.ctx.getImageData(0, 0, pe.width, pe.height);
  peSetCanvasSize(Math.min(512,Math.max(8,w)), Math.min(512,Math.max(8,h)));
  // Paste old data (top-left aligned)
  pe.ctx.clearRect(0,0,pe.width,pe.height);
  pe.ctx.putImageData(old, 0, 0);
  peDrawGrid();
  showToast(`Canvas resized to ${pe.width}√ó${pe.height}`, 'success');
}

// ‚îÄ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peExportPNG() {
  pe.canvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'pixel_art.png'; a.click();
    showToast('‚Üì Exported pixel_art.png', 'success');
  });
}

function peLoadFromGenerated() {
  if (!state.currentImage64) { showToast('Generate a sprite first!', 'error'); return; }
  pePushUndo();
  const img = new Image();
  img.onload = () => {
    peSetCanvasSize(img.width, img.height);
    pe.ctx.clearRect(0, 0, pe.width, pe.height);
    pe.ctx.drawImage(img, 0, 0);
    peZoomFit();
    peDrawGrid();
    showToast('Sprite loaded into editor!', 'success');
  };
  img.src = 'data:image/png;base64,' + state.currentImage64;
}

// ‚îÄ‚îÄ‚îÄ SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peShowSelection() {
  const sel = pe.selection;
  if (!sel) return;
  const box = document.getElementById('peSelectionBox');
  box.style.display = '';
  box.style.left   = (sel.x * pe.zoom) + 'px';
  box.style.top    = (sel.y * pe.zoom) + 'px';
  box.style.width  = (sel.w * pe.zoom) + 'px';
  box.style.height = (sel.h * pe.zoom) + 'px';
}

// ‚îÄ‚îÄ‚îÄ QUICK PALETTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peRenderQuickPalette() {
  const el = document.getElementById('peQuickPalette');
  el.innerHTML = pe.quickPalette.map(c => `
    <div style="background:${c};height:18px;border-radius:3px;cursor:pointer;border:1px solid rgba(255,255,255,0.1)"
      title="${c}" onclick="peSetFgColor('${c}')" oncontextmenu="peSetBgColor('${c}');event.preventDefault()"></div>
  `).join('');
}

function peAddToQuickPalette() {
  if (!pe.quickPalette.includes(pe.fgColor)) {
    pe.quickPalette.push(pe.fgColor);
    if (pe.quickPalette.length > 40) pe.quickPalette.shift();
    peRenderQuickPalette();
  }
}

function peLoadThemePalette(name) {
  const colors = pe.themePalettes[name] || pe.themePalettes.gameboy;
  const el = document.getElementById('pePaletteThemeSwatches');
  el.innerHTML = colors.map(c => `
    <div style="background:${c};height:14px;border-radius:2px;cursor:pointer;border:1px solid rgba(255,255,255,0.08)"
      title="${c}" onclick="peSetFgColor('${c}')" oncontextmenu="peSetBgColor('${c}');event.preventDefault()"></div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function peKeyDown(e) {
  // Only handle when pixel editor tab is visible
  if (document.getElementById('tab-pixeleditor').style.display === 'none') return;

  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'z') { e.preventDefault(); peUndo(); }
    if (e.key === 'y') { e.preventDefault(); peRedo(); }
    if (e.key === '+' || e.key === '=') { e.preventDefault(); peZoom(2); }
    if (e.key === '-') { e.preventDefault(); peZoom(-2); }
    return;
  }

  const toolMap = {
    'p':'pencil','b':'brush','e':'eraser','f':'fill',
    'i':'eyedropper','l':'line','r':'rect','c':'circle','s':'select'
  };
  const key = e.key.toLowerCase();
  if (toolMap[key]) {
    peTool(toolMap[key], document.getElementById('tool-'+toolMap[key]));
  }
  if (e.key === '+' || e.key === '=') peZoom(2);
  if (e.key === '-') peZoom(-2);
  if (e.key === 'x') peSwapColors();
  if (e.key === 'g') peToggleGrid(!pe.showGrid);
  if (e.key === '[') {
    const sizes = [1,2,4,8]; const i = sizes.indexOf(pe.brushSize);
    peBrushSize(sizes[Math.max(0,i-1)], document.getElementById('bsSwatch'+sizes[Math.max(0,i-1)]));
  }
  if (e.key === ']') {
    const sizes = [1,2,4,8]; const i = sizes.indexOf(pe.brushSize);
    peBrushSize(sizes[Math.min(sizes.length-1,i+1)], document.getElementById('bsSwatch'+sizes[Math.min(sizes.length-1,i+1)]));
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME TOGGLE ‚Äî Light / Dark
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'light' ? 'dark' : 'light';
  html.setAttribute('data-theme', next);
  localStorage.setItem('sprite-theme', next);
  updateThemeIcons(next);
}

function updateThemeIcons(theme) {
  const dark = document.getElementById('themeIconDark');
  const light = document.getElementById('themeIconLight');
  const toggle = document.getElementById('themeToggle');
  if (!dark || !light) return;
  if (theme === 'light') {
    dark.style.opacity = '0.35';
    light.style.opacity = '1';
    toggle.title = 'Switch to dark theme';
  } else {
    dark.style.opacity = '1';
    light.style.opacity = '0.35';
    toggle.title = 'Switch to light theme';
  }
}

// Restore saved preference on load
(function() {
  const saved = localStorage.getItem('sprite-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  // Icons update after DOM ready
  window.addEventListener('DOMContentLoaded', () => updateThemeIcons(saved));
})();

</script>
</body>
</html>
